<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบประกาศคะแนน (GradePro Cloud)</title>
    
    <!-- Google Fonts: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTML5-QRCode Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                },
            },
        }
    </script>
    
    <style>
        * { font-family: 'Prompt', sans-serif !important; }
        body { background-color: #f8fafc; color: #1e293b; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .modal-backdrop { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        #reader video, #direct-reader video { object-fit: cover; border-radius: 1rem; }
    </style>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, writeBatch, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- CONFIG ---
        let firebaseConfig;
        try { firebaseConfig = JSON.parse(__firebase_config); } catch(e) {
            firebaseConfig = { apiKey: "demo", authDomain: "demo.firebaseapp.com", projectId: "demo" };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'grade-pro-final-fixed';
        
        const PUBLIC_DATA_PATH = `artifacts/${appId}/public/data`;
        const STUDENTS_COLLECTION = `${PUBLIC_DATA_PATH}/students`;
        const CONFIG_DOC = `${PUBLIC_DATA_PATH}/config/main`;
        const SCANNER_COL_PATH = `artifacts/${appId}/public/data/scanner_sessions`;

        // --- ICONS ---
        const Icon = ({ p }) => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{p}</svg>;
        const Icons = {
            Search: <Icon p={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            User: <Icon p={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Lock: <Icon p={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            LogOut: <Icon p={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            Edit: <Icon p={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>} />,
            Trash: <Icon p={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Plus: <Icon p={<><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>} />,
            Camera: <Icon p={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            QrCode: <Icon p={<><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>} />,
            Settings: <Icon p={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Table: <Icon p={<><path d="M3 3h18v18H3zM3 9h18M9 21V9"/></>} />,
            Trash2: <Icon p={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            AlertTriangle: <Icon p={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} />,
            FolderPlus: <Icon p={<><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><line x1="12" x2="12" y1="10" y2="16"/><line x1="9" x2="15" y1="13" y2="13"/></>} />,
            EyeOff: <Icon p={<><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></>} />,
            CheckSquare: <Icon p={<><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>} />,
            Square: <Icon p={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></>} />,
            Filter: <Icon p={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
            Upload: <Icon p={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />,
            Download: <Icon p={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            Database: <Icon p={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} />,
            ArrowUp: <Icon p={<><line x1="12" x2="12" y1="19" y2="5"/><polyline points="5 12 12 5 19 12"/></>} />,
            Users: <Icon p={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            UserPlus: <Icon p={<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/></>} />
        };

        const SEED_SECTIONS = [{ id: 'sec1', title: 'บทที่ 1', color: 'blue', groups: [{ id: 'g1', title: 'คะแนนเก็บ', columns: [{ id: 'c1', name: 'งาน 1', max: 10, type: 'manual' }, { id: 'c2', name: 'รวม', max: 10, type: 'sum' }] }] }];
        const SEED_DATA = [{ id: '66001', no: '1', name: 'สมชาย', room: '1/1', scores: { 'c1': 8 } }];
        const THEMES = { blue: { bg: 'bg-blue-50', text: 'text-blue-800' }, green: { bg: 'bg-green-50', text: 'text-green-800' }, orange: { bg: 'bg-orange-50', text: 'text-orange-800' }, purple: { bg: 'bg-purple-50', text: 'text-purple-800' }, pink: { bg: 'bg-pink-50', text: 'text-pink-800' }, gray: { bg: 'bg-gray-50', text: 'text-gray-800' } };

        const { useState, useEffect, useRef, useMemo } = React;

        const MobileScanner = ({ sessionId, onClose }) => {
            const [status, setStatus] = useState("กำลังเริ่มกล้อง...");
            useEffect(() => {
                const scanner = new Html5Qrcode("reader");
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                    (text) => {
                        const code = text.trim();
                        if(code.includes("scan_session")) return;
                        setDoc(doc(db, SCANNER_COL_PATH, sessionId), { lastScanned: code, timestamp: Date.now() }, { merge: true })
                            .then(() => setStatus(`ส่ง: ${code}`))
                            .catch(e => setStatus("Error: " + e.message));
                        if(navigator.vibrate) navigator.vibrate(200);
                    },
                    (err) => {}
                ).catch(e => setStatus("เปิดกล้องไม่ได้"));
                return () => { scanner.stop().catch(e=>{}); };
            }, []);
            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center p-4">
                    <h3 className="text-white font-bold mb-4 text-lg">Mobile Scanner</h3>
                    <div id="reader" className="bg-white w-full rounded-lg overflow-hidden"></div>
                    <div className="text-white mt-4 text-center font-mono">{status}</div>
                    <button onClick={onClose} className="mt-8 bg-red-600 text-white px-6 py-2 rounded-full">ปิด</button>
                    <div className="text-gray-500 text-xs mt-2">Session: {sessionId}</div>
                </div>
            );
        };

        const WebScanner = ({ onClose, onScan }) => {
            useEffect(() => {
                const scanner = new Html5Qrcode("web-reader");
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                    (text) => {
                        const code = text.trim();
                        if(!code.startsWith("http")) {
                            onScan(code);
                            scanner.stop().then(()=>onClose()).catch(()=>onClose());
                        }
                    }, 
                    () => {}
                );
                return () => { scanner.stop().catch(e=>{}); };
            }, []);
            return (
                <div className="fixed inset-0 modal-backdrop z-50 flex flex-col items-center justify-center p-4">
                    <div className="bg-white p-4 rounded-xl shadow-xl w-full max-w-sm text-center">
                        <h3 className="font-bold mb-4">สแกนบาร์โค้ด</h3>
                        <div id="web-reader" className="bg-black rounded-lg overflow-hidden w-full"></div>
                        <button onClick={onClose} className="mt-4 text-red-500 font-bold">ยกเลิก</button>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('student'); 
            const [tab, setTab] = useState('scores'); 
            const [password, setPassword] = useState('');
            const [students, setStudents] = useState([]);
            const [sections, setSections] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const [activeModal, setActiveModal] = useState(null); 
            const [editingStudent, setEditingStudent] = useState(null);
            const [editColData, setEditColData] = useState(null); 
            const [sessionId, setSessionId] = useState(null);
            const [isMobileMode, setIsMobileMode] = useState(false);
            const [newSectionTitle, setNewSectionTitle] = useState('');
            const [targetSectionId, setTargetSectionId] = useState('');
            const [newColName, setNewColName] = useState('');
            const [newColMax, setNewColMax] = useState(10);
            const [newColType, setNewColType] = useState('manual');
            const [importText, setImportText] = useState('');
            const [selectedRoom, setSelectedRoom] = useState('All');
            
            const searchInputRef = useRef(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('scan_session')) {
                    setSessionId(params.get('scan_session'));
                    setIsMobileMode(true);
                }

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) signInWithCustomToken(auth, __initial_auth_token);
                else signInAnonymously(auth);

                const unsub1 = onSnapshot(doc(db, CONFIG_DOC), (s) => setSections(s.exists() ? s.data().sections || [] : []));
                const unsub2 = onSnapshot(collection(db, STUDENTS_COLLECTION), (s) => {
                    setStudents(s.docs.map(d => d.data()));
                    setLoading(false);
                });
                return () => { unsub1(); unsub2(); };
            }, []);

            useEffect(() => {
                if(!sessionId || isMobileMode) return;
                const unsub = onSnapshot(doc(db, SCANNER_COL_PATH, sessionId), (s) => {
                    const d = s.data();
                    if(d && d.lastScanned) {
                        const code = d.lastScanned.trim();
                        if(view === 'teacher') handleEditStudent(code);
                        else handleSearch(code);
                    }
                });
                return () => unsub();
            }, [sessionId, view, students]);

            const getColValue = (student, group, col) => {
                if(!group || !student) return '-';
                if(col.type === 'manual') return student.scores?.[col.id];

                if(col.type === 'sum') {
                    let sum = 0;
                    let count = 0;
                    group.columns.forEach(c => {
                        if(c.type === 'manual') {
                            const v = parseFloat(student.scores?.[c.id]);
                            if(!isNaN(v)) { sum += v; count++; }
                        }
                    });
                    return count > 0 ? parseFloat(sum.toFixed(2)) : '-';
                }

                if(col.type === 'percent') {
                    const idx = group.columns.findIndex(c => c.id === col.id);
                    if(idx > 0) {
                        const srcCol = group.columns[idx-1];
                        const srcVal = parseFloat(getColValue(student, group, srcCol));
                        let srcMax = srcCol.max || 100;
                        if(srcCol.type === 'sum') {
                            srcMax = group.columns.filter(c => c.type === 'manual').reduce((a,b) => a + (parseInt(b.max)||0), 0);
                            if(srcMax === 0) srcMax = 1;
                        }
                        if(!isNaN(srcVal)) return parseFloat(((srcVal/srcMax)*col.max).toFixed(2));
                    }
                }
                return '-';
            };

            const handleSearch = (code) => {
                const target = code || searchQuery;
                const found = students.find(s => s.id === target.trim());
                if(found) { setSearchResult(found); setSearchQuery(target.trim()); }
                else alert('ไม่พบรหัส: ' + target);
            };

            const handleEditStudent = (code) => {
                const target = code || searchQuery;
                const found = students.find(s => s.id === target.trim());
                if(found) {
                    setEditingStudent(JSON.parse(JSON.stringify(found)));
                    setActiveModal('edit');
                    setSearchQuery('');
                } else if(code) alert('ไม่พบรหัส: ' + code);
            };

            const saveStudent = async () => {
                await setDoc(doc(db, STUDENTS_COLLECTION, editingStudent.id), editingStudent);
                setActiveModal(null);
            };

            const addSection = async () => {
                if(!newSectionTitle) return;
                const newSec = { id: `s_${Date.now()}`, title: newSectionTitle, color: 'blue', groups: [] };
                await setDoc(doc(db, CONFIG_DOC), { sections: [...sections, newSec] });
                setNewSectionTitle('');
                alert('เพิ่มบทเรียนแล้ว');
            };

            const addColumn = async () => {
                if(!targetSectionId || !newColName) return;
                const newSections = [...sections];
                const sec = newSections.find(s => s.id === targetSectionId);
                
                let group = sec.groups.find(g => g.title === 'คะแนนเก็บ');
                if(!group) {
                    group = { id: `g_${Date.now()}`, title: 'คะแนนเก็บ', columns: [] };
                    sec.groups.push(group);
                }

                group.columns.push({
                    id: `c_${Date.now()}`,
                    name: newColName,
                    max: parseInt(newColMax),
                    type: newColType
                });

                await setDoc(doc(db, CONFIG_DOC), { sections: newSections });
                setNewColName('');
                alert('เพิ่มช่องคะแนนแล้ว');
            };

            const handleImport = async () => {
                const lines = importText.trim().split('\n');
                const batch = writeBatch(db);
                let count = 0;
                lines.forEach(l => {
                    const p = l.split(/[\t,]+|\s{2,}/).map(s => s.trim());
                    if(p.length >= 2) {
                        let id = p[0], name = p[1], room = p[2] || '-';
                        if(p[0].length < 4 && p[1].length >= 4) { id = p[1]; name = p[2]; room = p[3] || '-'; }
                        if(id && name) {
                            const old = students.find(s => s.id === id);
                            batch.set(doc(db, STUDENTS_COLLECTION, id), { id, name, room, scores: old ? old.scores : {} });
                            count++;
                        }
                    }
                });
                await batch.commit();
                alert(`นำเข้า ${count} คน`);
                setActiveModal(null);
            };

            const saveColumnEdit = async () => {
                if(!editColData) return;
                const newSections = [...sections];
                const sec = newSections.find(s => s.id === editColData.sectionId);
                const grp = sec.groups.find(g => g.id === editColData.groupId);
                const col = grp.columns.find(c => c.id === editColData.col.id);
                
                col.name = editColData.col.name;
                col.max = parseInt(editColData.col.max);

                await setDoc(doc(db, CONFIG_DOC), { sections: newSections });
                setActiveModal(null);
            };
            
            const deleteColumn = async () => {
                if(!editColData || !confirm('ลบช่องนี้? ข้อมูลคะแนนจะหายไป')) return;
                const newSections = [...sections];
                const sec = newSections.find(s => s.id === editColData.sectionId);
                const grp = sec.groups.find(g => g.id === editColData.groupId);
                grp.columns = grp.columns.filter(c => c.id !== editColData.col.id);

                const batch = writeBatch(db);
                batch.set(doc(db, CONFIG_DOC), { sections: newSections });
                
                students.forEach(s => {
                    if(s.scores && s.scores[editColData.col.id]) {
                        const newScores = {...s.scores};
                        delete newScores[editColData.col.id];
                        batch.update(doc(db, STUDENTS_COLLECTION, s.id), { scores: newScores });
                    }
                });

                await batch.commit();
                setActiveModal(null);
            };

            const resetSystem = async () => {
                if(!confirm('ล้างข้อมูลทั้งหมด?')) return;
                const batch = writeBatch(db);
                batch.set(doc(db, CONFIG_DOC), { sections: SEED_SECTIONS });
                batch.set(doc(db, STUDENTS_COLLECTION, '66001'), SEED_DATA[0]);
                await batch.commit();
                window.location.reload();
            };

            if(isMobileMode) return <MobileScanner sessionId={sessionId} onClose={() => { setIsMobileMode(false); window.location.search = ''; }} />;
            if(loading) return <div className="h-screen flex items-center justify-center text-gray-400">Loading...</div>;

            const sortedStudents = students
                .filter(s => selectedRoom === 'All' || s.room === selectedRoom)
                .sort((a,b) => a.id.localeCompare(b.id));

            return (
                <div className="min-h-screen pb-20">
                    <nav className="bg-white border-b px-4 py-3 sticky top-0 z-30 shadow-sm flex justify-between items-center">
                        <div className="font-bold text-blue-600 flex items-center gap-2 text-lg">
                            {Icons.FileSpreadsheet} GradePro Cloud
                        </div>
                        {view === 'student' ? 
                            <button onClick={() => setView('teacher_login')} className="text-sm text-gray-500 flex items-center gap-1">{Icons.Lock} ครู</button> : 
                            <button onClick={() => setView('student')} className="text-sm text-red-500 flex items-center gap-1">{Icons.LogOut} ออก</button>
                        }
                    </nav>

                    <main className="max-w-6xl mx-auto p-4">
                        {view === 'student' && (
                            <div className="max-w-md mx-auto mt-10">
                                <div className="bg-white p-6 rounded-2xl shadow-lg border border-blue-100 text-center">
                                    <h1 className="text-2xl font-bold text-gray-800 mb-2">ตรวจสอบคะแนน</h1>
                                    <div className="flex gap-2 mb-4 relative">
                                        <input type="text" className="w-full p-3 pl-4 pr-10 border rounded-xl outline-none focus:border-blue-500" placeholder="รหัสนักเรียน..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} onKeyDown={e => e.key==='Enter'&&handleSearch()}/>
                                        <button onClick={() => setActiveModal('scanner')} className="absolute right-14 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600">{Icons.Camera}</button>
                                        <button onClick={() => handleSearch()} className="bg-blue-600 text-white px-4 rounded-xl">{Icons.Search}</button>
                                    </div>
                                    
                                    {searchResult && (
                                        <div className="animate-fade-in text-left mt-6">
                                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
                                                <h2 className="font-bold text-xl text-blue-800">{searchResult.name}</h2>
                                                <p className="text-blue-600 text-sm">{searchResult.id} | {searchResult.room}</p>
                                            </div>
                                            <div className="space-y-4">
                                                {sections.map(sec => (
                                                    <div key={sec.id} className="border rounded-xl overflow-hidden bg-white">
                                                        <div className="bg-gray-50 p-3 font-bold text-gray-700">{sec.title}</div>
                                                        <div className="divide-y">
                                                            {sec.groups.flatMap(g => g.columns).map(col => (
                                                                <div key={col.id} className="flex justify-between p-3 text-sm">
                                                                    <span>{col.name}</span>
                                                                    <span className="font-bold">
                                                                        {getColValue(searchResult, sec.groups.find(g => g.columns.includes(col)), col)} 
                                                                        <span className="text-gray-300 font-normal text-xs"> / {col.max}</span>
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'teacher_login' && (
                            <div className="max-w-sm mx-auto mt-20 p-8 bg-white rounded-2xl shadow-xl text-center">
                                <h2 className="text-xl font-bold mb-4">เข้าสู่ระบบอาจารย์</h2>
                                <input type="password" placeholder="รหัสผ่าน (admin)" className="w-full p-3 border rounded-lg mb-4 text-center" value={password} onChange={e => setPassword(e.target.value)} />
                                <button onClick={() => password === 'admin' ? setView('teacher') : alert('รหัสผิด')} className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">เข้าใช้งาน</button>
                            </div>
                        )}

                        {view === 'teacher' && (
                            <div>
                                <div className="flex flex-wrap gap-4 mb-6 items-center bg-white p-3 rounded-xl shadow-sm border">
                                    <div className="flex gap-2 bg-gray-100 p-1 rounded-lg">
                                        <button onClick={() => setTab('scores')} className={`px-4 py-1 rounded-md text-sm font-bold ${tab === 'scores' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>คะแนน</button>
                                        <button onClick={() => setTab('students')} className={`px-4 py-1 rounded-md text-sm font-bold ${tab === 'students' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>รายชื่อ</button>
                                        <button onClick={() => setTab('settings')} className={`px-4 py-1 rounded-md text-sm font-bold ${tab === 'settings' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>ตั้งค่า</button>
                                    </div>
                                    
                                    <select className="bg-white border rounded-lg px-3 py-1.5 text-sm" value={selectedRoom} onChange={e => setSelectedRoom(e.target.value)}>
                                        <option value="All">ทุกห้อง</option>
                                        {[...new Set(students.map(s => s.room))].sort().map(r => <option key={r} value={r}>ห้อง {r}</option>)}
                                    </select>

                                    <div className="flex gap-2 relative flex-1 max-w-xs">
                                        <input ref={searchInputRef} type="text" placeholder="ค้นหา / สแกน..." className="w-full pl-8 pr-8 py-1.5 border rounded-lg text-sm" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleEditStudent()}/>
                                        <span className="absolute left-2.5 top-2 text-gray-400">{Icons.Search}</span>
                                        <button onClick={() => setActiveModal('scanner')} className="absolute right-2 top-1.5 text-gray-400 hover:text-blue-500">{Icons.Camera}</button>
                                    </div>

                                    <button onClick={() => {
                                        const sid = Math.random().toString(36).substr(2,6).toUpperCase();
                                        setSessionId(sid);
                                        setActiveModal('qr');
                                    }} className="text-xs font-bold px-3 py-1.5 rounded-lg border bg-gray-50 text-gray-600 flex items-center gap-1">
                                        {Icons.QrCode} Mobile Pair {sessionId && '✅'}
                                    </button>
                                </div>

                                {tab === 'scores' && (
                                    <div className="bg-white rounded-xl border shadow-sm overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead>
                                                <tr className="bg-gray-50 border-b">
                                                    <th className="p-3 sticky left-0 bg-gray-50 z-10 w-12 text-center">#</th>
                                                    <th className="p-3 sticky left-12 bg-gray-50 z-10 w-24">รหัส</th>
                                                    <th className="p-3 sticky left-36 bg-gray-50 z-10 w-48">ชื่อ-สกุล</th>
                                                    {sections.map(sec => (
                                                        sec.groups.flatMap(g => g.columns).map(col => (
                                                            <th key={col.id} className="p-2 border-l text-center min-w-[60px] relative h-32 align-bottom group cursor-pointer hover:bg-blue-50"
                                                                onClick={() => {
                                                                    setEditColData({ sectionId: sec.id, groupId: sec.groups.find(g => g.columns.includes(col)).id, col });
                                                                    setActiveModal('edit_col');
                                                                }}
                                                            >
                                                                <div className="vertical-text absolute bottom-8 left-1/2 -translate-x-1/2">{col.name}</div>
                                                                <span className="text-[10px] bg-gray-200 px-1 rounded">{col.max}</span>
                                                            </th>
                                                        ))
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {sortedStudents.map((s, i) => (
                                                    <tr key={s.id} className="border-b hover:bg-gray-50">
                                                        <td className="p-3 text-center sticky left-0 bg-white">{i+1}</td>
                                                        <td className="p-3 sticky left-12 bg-white font-mono">{s.id}</td>
                                                        <td className="p-3 sticky left-36 bg-white cursor-pointer hover:text-blue-600" onClick={() => handleEditStudent(s.id)}>{s.name}</td>
                                                        {sections.map(sec => (
                                                            sec.groups.map(g => (
                                                                g.columns.map(col => {
                                                                    const val = getColValue(s, g, col);
                                                                    const isAuto = col.type !== 'manual';
                                                                    return (
                                                                        <td key={col.id} className={`p-2 border-l text-center ${isAuto ? 'bg-gray-50 text-gray-500 font-bold' : ''}`}>
                                                                            {val}
                                                                        </td>
                                                                    );
                                                                })
                                                            ))
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {tab === 'students' && (
                                    <div className="max-w-4xl mx-auto space-y-4">
                                        <div className="flex justify-end gap-3">
                                            <button onClick={() => setActiveModal('import')} className="bg-white border hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">{Icons.Settings} นำเข้า (Excel)</button>
                                            <button onClick={() => {
                                                setEditingStudent({ id:'', name:'', room:'', scores:{} });
                                                setActiveModal('add_student');
                                            }} className="bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">{Icons.Plus} เพิ่มนักเรียน</button>
                                        </div>
                                        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                            {sortedStudents.map(s => (
                                                <div key={s.id} className="flex justify-between items-center p-4 border-b last:border-0 hover:bg-gray-50">
                                                    <div>
                                                        <div className="font-bold">{s.name}</div>
                                                        <div className="text-xs text-gray-500">{s.id} | ห้อง {s.room}</div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleEditStudent(s.id)} className="text-blue-500 hover:bg-blue-50 p-2 rounded-full">{Icons.Edit}</button>
                                                        <button onClick={async () => {
                                                            if(confirm('ลบ?')) {
                                                                await deleteDoc(doc(db, STUDENTS_COLLECTION, s.id));
                                                            }
                                                        }} className="text-red-500 hover:bg-red-50 p-2 rounded-full">{Icons.Trash}</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {tab === 'settings' && (
                                    <div className="max-w-4xl mx-auto space-y-6">
                                        <div className="bg-white p-6 rounded-xl border shadow-sm">
                                            <h3 className="font-bold text-lg mb-4">จัดการโครงสร้างคะแนน</h3>
                                            <div className="grid md:grid-cols-2 gap-4 mb-6">
                                                <div>
                                                    <label className="text-xs font-bold text-gray-500">สร้างบทเรียนใหม่</label>
                                                    <div className="flex gap-2 mt-1">
                                                        <input className="w-full p-2 border rounded-lg" placeholder="ชื่อบท..." value={newSectionTitle} onChange={e => setNewSectionTitle(e.target.value)} />
                                                        <button onClick={addSection} className="bg-blue-600 text-white px-3 rounded-lg text-sm font-bold">สร้าง</button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-xs font-bold text-gray-500">เพิ่มช่องคะแนน</label>
                                                    <select className="w-full p-2 border rounded-lg mt-1 mb-2" onChange={e => setTargetSectionId(e.target.value)} value={targetSectionId}>
                                                        <option value="">-- เลือกบทเรียน --</option>
                                                        {sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                                    </select>
                                                    <div className="flex gap-2 mb-2">
                                                        {['manual', 'sum', 'percent'].map(t => (
                                                            <button key={t} onClick={() => setNewColType(t)} className={`flex-1 py-1 rounded border text-xs ${newColType===t ? 'bg-blue-600 text-white' : 'bg-white'}`}>{t}</button>
                                                        ))}
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <input className="flex-1 p-2 border rounded-lg" placeholder="ชื่อช่อง" value={newColName} onChange={e => setNewColName(e.target.value)} />
                                                        <input className="w-16 p-2 border rounded-lg text-center" placeholder="เต็ม" value={newColMax} onChange={e => setNewColMax(e.target.value)} />
                                                        <button onClick={addColumn} className="bg-green-600 text-white px-3 rounded-lg text-sm font-bold">เพิ่ม</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button onClick={resetSystem} className="w-full bg-red-50 text-red-600 py-3 rounded-xl border border-red-200 hover:bg-red-100 font-bold">⚠ ล้างข้อมูลและลงตัวอย่างใหม่</button>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* --- MODALS --- */}
                        
                        {activeModal === 'qr' && (
                            <div className="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" onClick={() => setActiveModal(null)}>
                                <div className="bg-white p-6 rounded-2xl max-w-sm w-full text-center" onClick={e => e.stopPropagation()}>
                                    <h3 className="font-bold text-lg mb-4">Mobile Pair</h3>
                                    <div className="bg-white p-2 inline-block rounded-xl border mb-4">
                                        <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.href.split('?')[0] + '?scan_session=' + sessionId)}`} className="w-48 h-48"/>
                                    </div>
                                    <p className="text-sm text-gray-500">ใช้มือถือสแกนเพื่อเชื่อมต่อ</p>
                                </div>
                            </div>
                        )}

                        {activeModal === 'scanner' && (
                            <WebScanner onClose={() => setActiveModal(null)} onScan={(code) => {
                                setActiveModal(null);
                                if(view === 'teacher') handleEditStudent(code);
                                else handleSearch(code);
                            }}/>
                        )}

                        {activeModal === 'edit' && editingStudent && (
                            <div className="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" onClick={() => setActiveModal(null)}>
                                <div className="bg-white rounded-2xl w-full max-w-2xl h-[80vh] flex flex-col overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                                    <div className="bg-blue-600 p-4 text-white font-bold flex justify-between">
                                        <span>แก้ไขคะแนน: {editingStudent.name}</span>
                                        <button onClick={() => setActiveModal(null)}>{Icons.X}</button>
                                    </div>
                                    <div className="p-6 overflow-y-auto flex-1 bg-gray-50">
                                        <div className="grid gap-6">
                                            {sections.map(sec => (
                                                <div key={sec.id} className="bg-white p-4 rounded-xl border shadow-sm">
                                                    <h4 className="font-bold text-blue-600 mb-3 border-b pb-2">{sec.title}</h4>
                                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                                        {sec.groups.flatMap(g => g.columns).map(col => {
                                                            const isAuto = col.type !== 'manual';
                                                            const val = isAuto ? getColValue(editingStudent, sec.groups.find(g => g.columns.includes(col)), col) : (editingStudent.scores?.[col.id] || '');
                                                            
                                                            return (
                                                                <div key={col.id}>
                                                                    <div className="flex justify-between text-xs mb-1 text-gray-500">
                                                                        <span>{col.name}</span>
                                                                        <span>/{col.max}</span>
                                                                    </div>
                                                                    <input 
                                                                        type="text" 
                                                                        disabled={isAuto}
                                                                        className={`w-full p-2 border rounded-lg text-center font-bold outline-none focus:ring-2 focus:ring-blue-500 ${isAuto ? 'bg-gray-100 text-gray-400' : 'bg-white text-gray-800'}`}
                                                                        value={val}
                                                                        onChange={e => {
                                                                            if(isAuto) return;
                                                                            setEditingStudent(prev => ({
                                                                                ...prev,
                                                                                scores: { ...prev.scores, [col.id]: e.target.value }
                                                                            }));
                                                                        }}
                                                                    />
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="p-4 border-t bg-white flex justify-end">
                                        <button onClick={saveStudent} className="bg-blue-600 text-white px-8 py-2 rounded-xl font-bold hover:bg-blue-700 shadow-lg">บันทึก</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeModal === 'import' && (
                            <div className="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" onClick={() => setActiveModal(null)}>
                                <div className="bg-white p-6 rounded-2xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
                                    <h3 className="font-bold text-lg mb-4">นำเข้าข้อมูล (Excel Copy-Paste)</h3>
                                    <textarea className="w-full h-48 border rounded-lg p-3 text-xs font-mono mb-4" placeholder="รหัส [tab] ชื่อ [tab] ห้อง" id="import-text" value={importText} onChange={e => setImportText(e.target.value)}></textarea>
                                    <button onClick={() => handleImport()} className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">นำเข้า</button>
                                </div>
                            </div>
                        )}

                        {activeModal === 'add_student' && editingStudent && (
                            <div className="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" onClick={() => setActiveModal(null)}>
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm space-y-3" onClick={e => e.stopPropagation()}>
                                    <h3 className="font-bold text-lg">เพิ่มนักเรียน</h3>
                                    <input className="w-full p-2 border rounded" placeholder="รหัส" value={editingStudent.id} onChange={e => setEditingStudent({...editingStudent, id: e.target.value})}/>
                                    <input className="w-full p-2 border rounded" placeholder="ชื่อ-สกุล" value={editingStudent.name} onChange={e => setEditingStudent({...editingStudent, name: e.target.value})}/>
                                    <input className="w-full p-2 border rounded" placeholder="ห้อง" value={editingStudent.room} onChange={e => setEditingStudent({...editingStudent, room: e.target.value})}/>
                                    <button onClick={async () => {
                                        if(editingStudent.id && editingStudent.name) {
                                            await setDoc(doc(db, STUDENTS_COLLECTION, editingStudent.id), editingStudent);
                                            setActiveModal(null);
                                        }
                                    }} className="w-full bg-green-600 text-white py-2 rounded-lg font-bold">บันทึก</button>
                                </div>
                            </div>
                        )}

                        {activeModal === 'edit_col' && editColData && (
                            <div className="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4" onClick={() => setActiveModal(null)}>
                                <div className="bg-white p-6 rounded-2xl w-full max-w-sm space-y-4" onClick={e => e.stopPropagation()}>
                                    <h3 className="font-bold text-lg">แก้ไขช่องคะแนน</h3>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">ชื่อ</label>
                                        <input className="w-full p-2 border rounded" value={editColData.col.name} onChange={e => setEditColData({...editColData, col: {...editColData.col, name: e.target.value}})} disabled={editColData.col.type !== 'manual'}/>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">เต็ม</label>
                                        <input className="w-full p-2 border rounded" value={editColData.col.max} onChange={e => setEditColData({...editColData, col: {...editColData.col, max: e.target.value}})}/>
                                    </div>
                                    <div className="flex justify-between mt-4">
                                        <button onClick={deleteColumn} className="text-red-500 font-bold">ลบ</button>
                                        <button onClick={saveColumnEdit} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">บันทึก</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
