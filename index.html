<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GradePro Cloud v7.8 (Super Compact)</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'], display: ['Prompt', 'sans-serif'] },
                    colors: { 
                        primary: { 50:'#eff6ff', 100:'#dbeafe', 200:'#bfdbfe', 300:'#93c5fd', 400:'#60a5fa', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 800:'#1e40af', 900:'#1e3a8a' },
                        slate: { 850: '#151f32' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(59, 130, 246, 0.3)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        body { background-color: #f8fafc; color: #334155; -webkit-font-smoothing: antialiased; }
        h1, h2, h3, h4, h5, h6, .font-display, button { font-family: 'Prompt', sans-serif !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-scale { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Vertical Header Styles */
        .vertical-text {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            white-space: nowrap;
            text-align: left;
            height: 140px; 
            padding: 4px 0px; /* Reduced padding for compact 32px */
            margin: 0 auto;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Sticky Columns Configuration - Fixed Pixel Widths */
        .sticky-col { position: sticky; background-color: #ffffff; z-index: 40; } 
        
        /* Exact Widths */
        .sticky-left-0 { left: 0; width: 40px; min-width: 40px; max-width: 40px; border-right: 1px solid #e2e8f0; }
        .sticky-left-1 { left: 40px; width: 60px; min-width: 60px; max-width: 60px; border-right: 1px solid #e2e8f0; }
        .sticky-left-2 { left: 100px; width: 180px; min-width: 180px; max-width: 180px; border-right: 1px solid #e2e8f0; box-shadow: 4px 0 6px -4px rgba(0,0,0,0.1); }
        
        /* Header Specifics */
        thead { z-index: 50; position: sticky; top: 0; }
        thead th { background-color: #fff; }
        thead .sticky-col { z-index: 60; } 

        /* Row Backgrounds */
        tr:nth-child(even) .sticky-col { background-color: #ffffff; }
        tr:nth-child(odd) .sticky-col { background-color: #f8fafc; } 
        tr:hover .sticky-col { background-color: #eff6ff; } 

        /* Print Styles */
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 10pt; }
            .no-print, nav, button, .fixed-ui, ::-webkit-scrollbar, .toast-container, .virtual-numpad { display: none !important; }
            .print-only { display: block !important; width: 100%; height: auto; overflow: visible; }
            #root, main, .overflow-x-auto, .max-h-\[75vh\], .bg-white { overflow: visible !important; height: auto !important; max-height: none !important; width: 100% !important; position: static !important; box-shadow: none !important; border: none !important; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 15px; page-break-inside: auto; table-layout: auto !important; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            th, td { border: 1px solid #000 !important; padding: 4px; text-align: center; vertical-align: middle; }
            .text-left { text-align: left !important; padding-left: 8px !important; }
            @page { margin: 10mm; size: A4 landscape; } 
            .vertical-text-print { writing-mode: vertical-rl; transform: rotate(180deg); height: 120px; white-space: nowrap; text-align: left; margin: 0 auto; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, writeBatch, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG ---
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const userConfig = {
            apiKey: "AIzaSyAT_suSpvRBboyuf7cFaqlCidllBsJqYM0",
            authDomain: "studentgradesystem-2a33f.firebaseapp.com",
            projectId: "studentgradesystem-2a33f",
            storageBucket: "studentgradesystem-2a33f.firebasestorage.app",
            messagingSenderId: "339470940730",
            appId: "1:339470940730:web:cc60c26a4c209caa6d1303",
            measurementId: "G-7MZ12J60VQ"
        };
        const firebaseConfig = envConfig || userConfig;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gradepro-v7-pro'; 

        const DEFAULT_INFO = {
            school: 'โรงเรียนตัวอย่างวิทยา',
            subject: 'ชีววิทยา',
            code: 'ว30242',
            teacher: 'ครูสมศรี ใจดี',
            semester: '1',
            year: '2568',
            password: 'admin',
            grading: { '4': 80, '3.5': 75, '3': 70, '2.5': 65, '2': 60, '1.5': 55, '1': 50 }
        };

        // --- ICONS ---
        const Icon = ({ p, size=20, className="", onClick }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{cursor: onClick ? 'pointer' : 'inherit'}}>{p}</svg>
        );
        const Icons = {
            Cloud: (p) => <Icon {...p} p={<><path d="M17.5 19c0-1.7-1.3-3-3-3h-11a4 4 0 0 1-0-8h1a5 5 0 0 1 9.9-1 3 3 0 0 1 3.1 3"/></>} />,
            Search: (p) => <Icon {...p} p={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            User: (p) => <Icon {...p} p={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Lock: (p) => <Icon {...p} p={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            LogOut: (p) => <Icon {...p} p={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            Edit: (p) => <Icon {...p} p={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>} />,
            Trash: (p) => <Icon {...p} p={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></>} />,
            Plus: (p) => <Icon {...p} p={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Camera: (p) => <Icon {...p} p={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Settings: (p) => <Icon {...p} p={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Alert: (p) => <Icon {...p} p={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
            X: (p) => <Icon {...p} p={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            ChevronDown: (p) => <Icon {...p} p={<><polyline points="6 9 12 15 18 9"/></>} />,
            ChevronRight: (p) => <Icon {...p} p={<><polyline points="9 18 15 12 9 6"/></>} />,
            ChevronLeft: (p) => <Icon {...p} p={<><polyline points="15 18 9 12 15 6"/></>} />,
            Print: (p) => <Icon {...p} p={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />,
            Users: (p) => <Icon {...p} p={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            FileText: (p) => <Icon {...p} p={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />,
            Upload: (p) => <Icon {...p} p={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Eye: (p) => <Icon {...p} p={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>} />,
            EyeOff: (p) => <Icon {...p} p={<><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>} />,
            Share: (p) => <Icon {...p} p={<><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></>} />,
            Chart: (p) => <Icon {...p} p={<><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></>} />,
            Activity: (p) => <Icon {...p} p={<><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></>} />,
            QrCode: (p) => <Icon {...p} p={<><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>} />,
            Calculator: (p) => <Icon {...p} p={<><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />,
            Download: (p) => <Icon {...p} p={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            Backspace: (p) => <Icon {...p} p={<><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></>} />,
            Note: (p) => <Icon {...p} p={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>} />,
            Refresh: (p) => <Icon {...p} p={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />,
            Database: (p) => <Icon {...p} p={<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>} />,
            Save: (p) => <Icon {...p} p={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Popup: (p) => <Icon {...p} p={<><path d="M3 3h18v18H3zM15 9l-6 6M9 9l6 6"/></>} />, 
            Maximize: (p) => <Icon {...p} p={<><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></>} />
        };

        const SECTION_COLORS = [
            { bg: 'bg-pink-300', border: 'border-pink-400', text: 'text-pink-900' },
            { bg: 'bg-sky-300', border: 'border-sky-400', text: 'text-sky-900' },
            { bg: 'bg-orange-300', border: 'border-orange-400', text: 'text-orange-900' },
            { bg: 'bg-purple-300', border: 'border-purple-400', text: 'text-purple-900' },
            { bg: 'bg-emerald-300', border: 'border-emerald-400', text: 'text-emerald-900' },
        ];

        // --- COMPONENTS ---

        function Modal({ isOpen, title, children, onClose, footer }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all animate-scale overflow-hidden relative z-10 max-h-[90vh] flex flex-col">
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800 font-display">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 bg-white rounded-full p-1 shadow-sm"><Icons.X size={18}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                        {footer && (
                            <div className="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-2">
                                {footer}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function ScoreEntryModal({ isOpen, data, onClose, onSave, onNavigate }) {
            if (!isOpen || !data) return null;
            const { student, column, currentVal } = data;
            const [val, setVal] = React.useState(currentVal);
            
            React.useEffect(() => { setVal(data.currentVal); }, [data]);

            const handleSave = () => {
                onSave(val);
            };

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate-scale ring-4 ring-white/20">
                        <div className="bg-slate-800 text-white p-6 flex justify-between items-start relative overflow-hidden">
                             <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 pointer-events-none"></div>
                            <div className="relative z-10">
                                <div className="text-sm opacity-75 font-mono mb-1">{student.id} | ห้อง {student.room}</div>
                                <div className="text-2xl font-bold font-display leading-tight">{student.name}</div>
                            </div>
                            <button onClick={onClose} className="bg-white/10 hover:bg-white/20 p-2 rounded-full transition relative z-10"><Icons.X className="text-white"/></button>
                        </div>
                        <div className="p-8">
                            <div className="text-center mb-8">
                                <div className="text-sm font-bold text-slate-400 uppercase tracking-wide mb-3">{column.name}</div>
                                <div className="flex justify-center items-end gap-3">
                                    <input 
                                        autoFocus
                                        type="number" 
                                        className="text-6xl font-bold text-center text-primary-600 w-40 border-b-4 border-primary-200 focus:border-primary-600 outline-none bg-transparent transition-colors font-mono"
                                        value={val}
                                        placeholder="-"
                                        onChange={e => setVal(e.target.value)}
                                        onKeyDown={e => {
                                            if(e.key === 'Enter') { handleSave(); onNavigate(1); }
                                        }}
                                    />
                                    <span className="text-2xl text-slate-300 font-bold mb-3 font-mono">/{column.max}</span>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                 <button onClick={() => { handleSave(); onNavigate(-1); }} className="py-4 rounded-2xl bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold flex items-center justify-center gap-2 transition active:scale-95"><Icons.ChevronLeft/> คนก่อน</button>
                                 <button onClick={() => { handleSave(); onNavigate(1); }} className="py-4 rounded-2xl bg-primary-600 hover:bg-primary-700 text-white font-bold flex items-center justify-center gap-2 shadow-lg shadow-primary-200 transition active:scale-95">ถัดไป <Icons.ChevronRight/></button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function VirtualNumpad({ isOpen, onInput, onClose }) {
            const { useState, useRef, useEffect } = React;
            if (!isOpen) return null;
            const [pos, setPos] = useState({ x: window.innerWidth - 280, y: 100 });
            const [dragging, setDragging] = useState(false);
            const offset = useRef({ x: 0, y: 0 });

            useEffect(() => {
                const move = (e) => {
                    if (dragging) setPos({ x: e.clientX - offset.current.x, y: e.clientY - offset.current.y });
                };
                const up = () => setDragging(false);
                window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
                return () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
            }, [dragging]);

            return (
                <div className="fixed z-[150] bg-white rounded-2xl shadow-2xl border border-slate-200 w-64 overflow-hidden animate-scale virtual-numpad" style={{ left: pos.x, top: pos.y }}>
                    <div className="bg-slate-100 p-2 cursor-move flex justify-between items-center border-b border-slate-200" onMouseDown={e => { setDragging(true); offset.current = { x: e.clientX - pos.x, y: e.clientY - pos.y }; }}>
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wide flex items-center gap-1"><Icons.Calculator size={12}/> Keypad</span>
                        <button onClick={onClose}><Icons.X size={14} className="text-slate-400 hover:text-red-500"/></button>
                    </div>
                    <div className="grid grid-cols-3 gap-2 p-3 bg-slate-50">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, '.', 0].map(k => (
                            <button key={k} onClick={() => onInput(k)} className="h-12 bg-white rounded-lg shadow-sm border border-slate-200 font-bold text-xl text-slate-700 active:scale-95 transition hover:bg-primary-50 hover:border-primary-200">{k}</button>
                        ))}
                        <button onClick={() => onInput('Del')} className="h-12 bg-red-50 rounded-lg shadow-sm border border-red-100 font-bold text-red-500 active:scale-95 transition flex items-center justify-center"><Icons.Backspace size={20}/></button>
                    </div>
                </div>
            );
        }

        function Scanner({ onScan, onClose }) {
            const { useEffect } = React;
            useEffect(() => {
                const scanner = new Html5Qrcode("reader");
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                    onScan(decodedText); scanner.stop().catch(console.error);
                }, () => {}).catch(console.error);
                return () => { try { scanner.stop(); } catch(e) {} };
            }, []);
            return (
                <div className="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center p-4">
                    <button onClick={onClose} className="absolute top-6 right-6 text-white bg-white/20 p-2 rounded-full backdrop-blur-md"><Icons.X size={24}/></button>
                    <h3 className="text-white text-xl font-bold mb-6 font-display animate-pulse">Scanning...</h3>
                    <div id="reader" className="w-full max-w-sm bg-black rounded-3xl overflow-hidden shadow-2xl border-4 border-primary-500/50"></div>
                </div>
            );
        }

        function MobilePairModal({ onClose, sessionId }) {
            const qrRef = React.useRef(null);
            React.useEffect(() => {
                if (qrRef.current) new QRCode(qrRef.current, { text: window.location.href.split('?')[0] + '?scan_session=' + sessionId, width: 180, height: 180 });
            }, []);
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[200] p-4">
                    <div className="bg-white p-8 rounded-3xl text-center max-w-sm w-full relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icons.X/></button>
                        <h3 className="text-xl font-bold mb-2 font-display">Mobile Pair</h3>
                        <p className="text-sm text-slate-500 mb-6">ใช้มือถือสแกนเพื่อเปลี่ยนเป็นเครื่องยิงบาร์โค้ด</p>
                        <div ref={qrRef} className="inline-block p-4 border-2 border-dashed border-primary-200 rounded-xl mb-4"></div>
                        <div className="text-xs font-mono bg-slate-100 p-2 rounded text-slate-500">Session: {sessionId}</div>
                    </div>
                </div>
            );
        }

        function ProgressBar({ current, max, color }) {
            const percent = max > 0 ? (current / max) * 100 : 0;
            return (
                <div className="w-full bg-slate-100 rounded-full h-2.5 dark:bg-gray-700 mt-1 overflow-hidden border border-slate-200">
                    <div className={`h-2.5 rounded-full ${color}`} style={{ width: `${Math.min(percent, 100)}%` }}></div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const { useState, useEffect, useRef, useMemo } = React;
            
            // State
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState(null);
            const [view, setView] = useState('student');
            const [students, setStudents] = useState([]);
            const [sections, setSections] = useState([]);
            const [sysInfo, setSysInfo] = useState(DEFAULT_INFO);
            const [presence, setPresence] = useState([]);
            const [accessLogs, setAccessLogs] = useState([]);
            
            // UI State
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedRoom, setSelectedRoom] = useState('All');
            const [studentViewData, setStudentViewData] = useState(null);
            const [teacherTab, setTeacherTab] = useState('scores');
            const [modal, setModal] = useState({ type: null, data: null });
            const [scannerOpen, setScannerOpen] = useState(false);
            const [teacherPassword, setTeacherPassword] = useState('');
            const [importText, setImportText] = useState('');
            const [isImporting, setIsImporting] = useState(false);
            const [toast, setToast] = useState(null);
            const [numpadOpen, setNumpadOpen] = useState(false);
            const [mobilePairOpen, setMobilePairOpen] = useState(false);
            const [sessionId, setSessionId] = useState('');
            const [isMobileScanner, setIsMobileScanner] = useState(false);
            const [isPopupMode, setIsPopupMode] = useState(false);
            const [activeScoreEntry, setActiveScoreEntry] = useState(null);
            const restoreInputRef = useRef(null);

            // Init
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('scan_session')) {
                    setIsMobileScanner(true);
                    setSessionId(params.get('scan_session'));
                }
                const init = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (error) { console.error("Auth Failed", error); }
                };
                init();
                return onAuthStateChanged(auth, (u) => { setUser(u); if (!u) setLoading(false); });
            }, []);

            // Data Sync
            useEffect(() => {
                if (!user) return;
                const unsubSections = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main'), (d) => {
                    if (d.exists()) {
                        const data = d.data();
                        setSections(data.sections || []);
                        if(data.info) setSysInfo({ ...DEFAULT_INFO, ...data.info });
                    }
                });
                const unsubStudents = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'students'), (snap) => {
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    setStudents(list);
                    setLoading(false);
                });
                const presenceRef = doc(db, 'artifacts', appId, 'public', 'data', 'presence', user.uid);
                const heartbeat = setInterval(() => {
                    setDoc(presenceRef, { lastSeen: Date.now(), role: view, viewing: studentViewData?.name || null }, { merge: true });
                }, 10000);
                
                let unsubLogs = () => {};
                let unsubPresence = () => {};
                if (view === 'teacher') {
                    unsubPresence = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'presence'), (snap) => {
                        const active = [];
                        const now = Date.now();
                        snap.forEach(d => { if (now - d.data().lastSeen < 60000) active.push(d.data()); });
                        setPresence(active);
                    });
                    unsubLogs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), (snap) => {
                        const logs = [];
                        snap.forEach(d => logs.push(d.data()));
                        setAccessLogs(logs.sort((a,b) => b.time - a.time).slice(0, 50));
                    });
                }

                let unsubSession = () => {};
                if (sessionId && !isMobileScanner) {
                    unsubSession = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId), (d) => {
                        if (d.exists() && d.data().scanned) {
                            handleScan(d.data().scanned);
                            setDoc(d.ref, { scanned: null }, { merge: true });
                        }
                    });
                }

                return () => { unsubSections(); unsubStudents(); clearInterval(heartbeat); unsubLogs(); unsubPresence(); unsubSession(); };
            }, [user, view, studentViewData, sessionId]);

            // Helpers
            const showToast = (msg, type='info') => { setToast({ msg, type }); setTimeout(() => setToast(null), 3000); };
            const getScore = (s, cId) => s.scores?.[cId] || '';
            const calculateAutoScore = (s, g, c) => {
                if (!g.columns) return '-';
                let total = 0, max = 0;
                g.columns.filter(cl => cl.type === 'manual').forEach(cl => {
                    total += parseFloat(s.scores?.[cl.id] || 0); max += parseFloat(cl.max || 0);
                });
                if (c.type === 'sum') return Math.ceil(total);
                if (c.type === 'percent') return max === 0 ? 0 : Math.ceil((total / max) * (c.max || 100));
                return '-';
            };

            // --- INTELLIGENCE FEATURES v7.0 (Fixed Logic) ---
            const calculateTotalScore = (student) => {
                let totalPercent = 0;
                let hasPercent = false;
                let totalManual = 0;

                sections.forEach(s => s.groups?.forEach(g => g.columns?.forEach(c => {
                    if (c.type === 'percent') {
                        const val = calculateAutoScore(student, g, c);
                        if (val !== '-') {
                            totalPercent += parseFloat(val);
                        }
                        hasPercent = true;
                    } else if (c.type === 'manual') {
                        totalManual += parseFloat(student.scores?.[c.id] || 0);
                    }
                })));

                // Prefer % score if available, otherwise raw score
                return Math.ceil(hasPercent ? totalPercent : totalManual);
            };

            const calculateGrade = (score) => {
                const g = sysInfo.grading || DEFAULT_INFO.grading;
                if(score >= g['4']) return 4;
                if(score >= g['3.5']) return 3.5;
                if(score >= g['3']) return 3;
                if(score >= g['2.5']) return 2.5;
                if(score >= g['2']) return 2;
                if(score >= g['1.5']) return 1.5;
                if(score >= g['1']) return 1;
                return 0;
            };

            const calculateColumnStats = (colId) => {
                const scores = filteredStudents.map(s => parseFloat(s.scores?.[colId] || 0));
                if (scores.length === 0) return { avg: '-', max: '-', min: '-' };
                const sum = scores.reduce((a, b) => a + b, 0);
                const avg = (sum / scores.length).toFixed(1);
                const max = Math.max(...scores);
                const min = Math.min(...scores);
                return { avg, max, min };
            };

            // Actions
            const updateStudent = async (data) => {
                if (!user) return;
                try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', data.id), data, { merge: true }); showToast('บันทึกแล้ว', 'success'); }
                catch (e) { showToast('Error', 'error'); }
            };
            const deleteStudent = async (id) => {
                setModal({ type: 'confirm', title: 'ยืนยันลบ', message: 'ลบข้อมูลนักเรียนนี้?', onConfirm: async () => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id)); setModal(null); showToast('ลบแล้ว', 'success');
                }});
            };
            const saveConfig = async (newSecs, newInfo) => {
                const payload = {}; if(newSecs) payload.sections = newSecs; if(newInfo) payload.info = newInfo;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main'), payload, { merge: true });
            };
            const handleScan = (txt) => {
                const s = students.find(x => x.id === txt || x.name === txt);
                if (s) { 
                    showToast(`พบ: ${s.name}`, 'success'); 
                    if (view === 'student') { setStudentViewData(s); setSearchQuery(''); logAccess(s); }
                    else { setSearchQuery(s.id); } 
                } else showToast('ไม่พบข้อมูล', 'error');
            };
            const logAccess = (s) => {
                addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                    student: s.name, id: s.id, room: s.room, time: Date.now()
                });
            };
            const handleExportCSV = () => {
                let csv = "\uFEFFเลขที่,รหัส,ชื่อ,ห้อง";
                sections.forEach(s => s.groups?.forEach(g => g.columns?.forEach(c => csv += `,${c.name}(${c.max})`)));
                csv += ",รวม,เกรด\n";
                filteredStudents.forEach(s => {
                    let row = `${s.no},${s.id},${s.name},${s.room}`;
                    sections.forEach(sec => sec.groups?.forEach(grp => grp.columns?.forEach(col => {
                        const val = col.type === 'manual' ? getScore(s, col.id) : calculateAutoScore(s, grp, col);
                        row += `,${val || ''}`;
                    })));
                    const total = calculateTotalScore(s);
                    row += `,${total},${calculateGrade(total)}`;
                    csv += row + "\n";
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob); link.download = "scores.csv";
                link.click();
            };
            const handleBackup = () => {
                const data = JSON.stringify({ students, sections, info: sysInfo });
                const blob = new Blob([data], { type: 'application/json' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob); link.download = "gradepro_backup.json";
                link.click();
            };
            const handleImport = async () => {
                if (!importText) return;
                setIsImporting(true);
                const lines = importText.trim().split('\n');
                const batch = writeBatch(db);
                let c = 0;
                lines.forEach(l => {
                    const p = l.trim().split(/[\t,]+/);
                    if (p.length >= 2) {
                        const id = p[0].trim();
                        batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), { id, name: p[1].trim(), room: p[2]||'', no: p[3]||'', scores: {} }, { merge: true });
                        c++;
                    }
                });
                if (c > 0) { await batch.commit(); showToast(`นำเข้า ${c} รายการ`, 'success'); setModal(null); setImportText(''); }
                setIsImporting(false);
            };

            const handleRestore = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.students && data.sections) {
                            if (!confirm('ข้อมูลปัจจุบันจะถูกเขียนทับ ยืนยันการกู้คืน?')) return;
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main'), { sections: data.sections, info: data.info || DEFAULT_INFO }, { merge: true });
                            const batch = writeBatch(db);
                            data.students.forEach(s => { batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id), s); });
                            await batch.commit();
                            showToast('กู้คืนข้อมูลสำเร็จ!', 'success');
                            window.location.reload();
                        } else { showToast('ไฟล์ไม่ถูกต้อง', 'error'); }
                    } catch (err) { console.error(err); showToast('เกิดข้อผิดพลาดในการอ่านไฟล์', 'error'); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const handleClearData = async () => {
                setModal({ type: 'confirm', title: '⚠ ล้างข้อมูลทั้งหมด', message: 'คุณแน่ใจหรือไม่ที่จะลบข้อมูลนักเรียนและคะแนนทั้งหมด?', onConfirm: async () => {
                    const batch = writeBatch(db);
                    students.forEach(s => { batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id)); });
                    await batch.commit();
                    setModal(null);
                    showToast('ล้างข้อมูลเรียบร้อย', 'success');
                }});
            };

            // Score Entry Modal Handlers
            const openScoreModal = (student, column) => {
                const currentVal = student.scores?.[column.id] || '';
                setActiveScoreEntry({ student, column, currentVal });
            };

            const handleScoreSave = (val) => {
                if(!activeScoreEntry) return;
                const { student, column } = activeScoreEntry;
                if (val === '' || (!isNaN(val) && parseFloat(val) <= parseFloat(column.max))) {
                    const newScores = { ...student.scores, [column.id]: val };
                    setStudents(prev => prev.map(p => p.id === student.id ? { ...student, scores: newScores } : p)); 
                    updateStudent({ ...student, scores: newScores });
                }
            };

            const navigateScoreEntry = (direction) => {
                if(!activeScoreEntry) return;
                const idx = filteredStudents.findIndex(s => s.id === activeScoreEntry.student.id);
                const nextIdx = idx + direction;
                if(nextIdx >= 0 && nextIdx < filteredStudents.length) {
                    const nextStudent = filteredStudents[nextIdx];
                    const nextVal = nextStudent.scores?.[activeScoreEntry.column.id] || '';
                    setActiveScoreEntry({ ...activeScoreEntry, student: nextStudent, currentVal: nextVal });
                }
            };


            const filteredStudents = useMemo(() => {
                let res = students;
                if (selectedRoom !== 'All') res = res.filter(s => s.room === selectedRoom);
                if (searchQuery) { const q = searchQuery.toLowerCase(); res = res.filter(s => s.id.includes(q) || s.name.toLowerCase().includes(q)); }
                return res.sort((a,b) => (a.room === b.room ? (parseInt(a.no)||0)-(parseInt(b.no)||0) : a.room.localeCompare(b.room)));
            }, [students, selectedRoom, searchQuery]);
            const uniqueRooms = useMemo(() => [...new Set(students.map(s => s.room).filter(Boolean))].sort(), [students]);
            
            const analysisData = useMemo(() => {
                const data = { high: [], mid: [], low: [] };
                let totalMax = 0;
                sections.forEach(s => s.groups?.forEach(g => g.columns?.forEach(c => { if(c.type==='manual') totalMax += parseFloat(c.max); })));
                if(totalMax === 0) return data;
                filteredStudents.forEach(s => {
                    const total = calculateTotalScore(s);
                    // Use a standard 100 base for categorization or adjust logic if needed
                    const pct = total; // Assuming total score is out of 100 for now based on grading scale
                    if(pct >= 80) data.high.push(s); else if(pct >= 50) data.mid.push(s); else data.low.push(s);
                });
                return data;
            }, [filteredStudents, sections]);

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div></div>;

            if (isMobileScanner) return (
                <div className="fixed inset-0 bg-black flex flex-col items-center justify-center p-4">
                    <h1 className="text-white font-bold text-xl mb-4">Mobile Scanner</h1>
                    <div id="reader" className="w-full max-w-sm bg-gray-800 rounded-xl overflow-hidden border-2 border-primary-500"></div>
                    <button onClick={() => {
                        const scanner = new Html5Qrcode("reader");
                        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId), { scanned: txt }, { merge: true });
                            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
                        }, () => {}).catch(console.error);
                    }} className="mt-6 bg-primary-600 text-white px-8 py-3 rounded-full font-bold shadow-lg animate-pulse">แตะเพื่อเริ่มสแกน</button>
                    <div className="text-white/50 mt-4 text-sm">Session: {sessionId}</div>
                </div>
            );

            return (
                <div className="min-h-screen pb-20 no-print font-sans">
                    {toast && <div className={`fixed top-4 right-4 z-[300] px-6 py-3 rounded-xl shadow-lg font-bold text-white animate-fade-in toast-container ${toast.type==='error'?'bg-red-500':'bg-green-500'}`}>{toast.msg}</div>}
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm glass-panel">
                        <div className="w-full px-4 h-16 flex justify-between items-center">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('student')}>
                                <div className="bg-gradient-to-tr from-primary-600 to-primary-400 text-white p-2 rounded-lg shadow-glow"><Icons.Cloud size={20}/></div>
                                <div className="leading-tight"><div className="font-display font-bold text-xl text-slate-800 tracking-tight">GradePro <span className="text-primary-600 text-sm">v7.8</span></div><div className="text-[10px] text-slate-500 font-medium hidden sm:block">{sysInfo.school}</div></div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => { navigator.clipboard.writeText(window.location.href); showToast('คัดลอกลิงก์แล้ว'); }} className="text-slate-500 hover:text-primary-600 px-2 py-2 rounded-full transition"><Icons.Share size={20}/></button>
                                {view === 'teacher' ? <button onClick={() => setView('student')} className="text-sm font-medium text-slate-500 hover:text-primary-600 px-3 py-2">ออก</button> : <button onClick={() => setView('teacher_login')} className="bg-slate-800 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-slate-900 shadow-lg">ครูผู้สอน</button>}
                            </div>
                        </div>
                    </nav>

                    <main className="w-full p-4 md:p-6">
                        {/* Student View... same as before */}
                        {view === 'student' && (
                            <div className="max-w-md mx-auto mt-10 animate-slide-up">
                                <div className="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                                    <div className="bg-gradient-to-r from-primary-600 to-primary-500 p-8 text-center text-white relative">
                                        <div className="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                                        <h2 className="text-3xl font-bold mb-1 font-display relative z-10">ตรวจสอบคะแนน</h2>
                                        <p className="text-primary-100 text-sm relative z-10">{sysInfo.subject} ({sysInfo.code})</p>
                                    </div>
                                    <div className="p-6">
                                        <div className="relative mb-6">
                                            <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400"><Icons.Search/></div>
                                            <input type="text" placeholder="รหัส หรือ ชื่อนักเรียน..." className="w-full pl-11 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-primary-100 focus:border-primary-500 outline-none transition font-medium text-lg" value={searchQuery} onChange={e => { setSearchQuery(e.target.value); setStudentViewData(null); }} />
                                        </div>
                                        {searchQuery.length > 1 && !studentViewData && (
                                            <div className="space-y-2">
                                                {filteredStudents.slice(0, 5).map(s => (
                                                    <button key={s.id} onClick={() => { setStudentViewData(s); setSearchQuery(''); logAccess(s); }} className="w-full text-left p-4 rounded-xl border border-slate-100 hover:border-primary-200 hover:bg-primary-50 transition flex items-center justify-between group">
                                                        <div><div className="font-bold text-slate-700 group-hover:text-primary-700">{s.name}</div><div className="text-xs text-slate-400 font-mono">ID: {s.id}</div></div>
                                                        <span className="bg-white text-slate-500 px-2 py-1 rounded text-xs border group-hover:border-primary-200">{s.room}</span>
                                                    </button>
                                                ))}
                                                {filteredStudents.length === 0 && <div className="text-center text-slate-400 py-4">ไม่พบข้อมูล</div>}
                                            </div>
                                        )}
                                        {studentViewData && (
                                            <div className="animate-fade-in">
                                                <div className="flex items-center gap-4 mb-6">
                                                    <div className="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center text-primary-600 shadow-inner"><Icons.User size={32}/></div>
                                                    <div><h3 className="text-xl font-bold text-slate-800">{studentViewData.name}</h3><p className="text-slate-500 text-sm">ชั้น {studentViewData.room} เลขที่ {studentViewData.no}</p></div>
                                                </div>
                                                
                                                <div className="mb-6 flex justify-between items-center p-4 bg-gradient-to-r from-slate-800 to-slate-700 text-white rounded-xl shadow-lg">
                                                    <div><div className="text-xs text-slate-300 uppercase tracking-wider">คะแนนรวม</div><div className="text-2xl font-bold">{calculateTotalScore(studentViewData)} <span className="text-sm font-normal text-slate-400">/ 100</span></div></div>
                                                    <div className="text-right"><div className="text-xs text-slate-300 uppercase tracking-wider">เกรด</div><div className="text-3xl font-bold text-yellow-400">{calculateGrade(calculateTotalScore(studentViewData))}</div></div>
                                                </div>

                                                <div className="space-y-4">
                                                    {sections.map(sec => sec.published !== false && (
                                                        <div key={sec.id} className="border border-slate-200 rounded-2xl overflow-hidden">
                                                            <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 font-bold text-slate-700 font-display flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-primary-500"></div> {sec.title}</div>
                                                            <div className="p-4 bg-white space-y-3">
                                                                {sec.groups?.map(grp => grp.published !== false && grp.columns?.map(col => {
                                                                    let val = col.type === 'manual' ? getScore(studentViewData, col.id) : calculateAutoScore(studentViewData, grp, col);
                                                                    let numVal = parseFloat(val);
                                                                    let max = parseFloat(col.max);
                                                                    let color = numVal >= max*0.8 ? 'bg-green-500' : (numVal >= max*0.5 ? 'bg-yellow-500' : 'bg-red-500');
                                                                    return (
                                                                        <div key={col.id}>
                                                                            <div className="flex justify-between items-center text-sm mb-1">
                                                                                <span className="font-medium text-slate-600">{col.name}</span>
                                                                                <span className="font-bold text-slate-800">{val} <span className="text-slate-400 font-normal">/{col.max}</span></span>
                                                                            </div>
                                                                            {!isNaN(numVal) && <ProgressBar current={numVal} max={max} color={color} />}
                                                                        </div>
                                                                    );
                                                                }))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                {studentViewData.note && <div className="mt-4 p-4 bg-yellow-50 text-yellow-800 rounded-xl text-sm border border-yellow-200"><strong>หมายเหตุ:</strong> {studentViewData.note}</div>}
                                                <button onClick={() => window.print()} className="mt-6 w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg hover:bg-slate-900 transition flex items-center justify-center gap-2"><Icons.Print size={18}/> พิมพ์ผลการเรียน</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'teacher_login' && (
                            <div className="max-w-sm mx-auto mt-20 text-center animate-scale">
                                <div className="bg-white p-8 rounded-3xl shadow-xl border border-slate-100">
                                    <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-600"><Icons.Lock size={32}/></div>
                                    <h2 className="text-2xl font-bold text-slate-800 mb-2 font-display">เข้าสู่ระบบครู</h2>
                                    <p className="text-slate-400 text-sm mb-6">สำหรับ {sysInfo.teacher}</p>
                                    <input type="password" className="w-full p-4 text-center bg-slate-50 border border-slate-200 rounded-2xl mb-4 focus:ring-4 focus:ring-primary-100 focus:border-primary-500 outline-none transition text-xl tracking-widest" placeholder="Password" value={teacherPassword} onChange={e => setTeacherPassword(e.target.value)} onKeyDown={e => e.key === 'Enter' && (teacherPassword === sysInfo.password ? setView('teacher') : showToast('รหัสผ่านไม่ถูกต้อง', 'error'))} />
                                    <button onClick={() => teacherPassword === sysInfo.password ? setView('teacher') : showToast('รหัสผ่านไม่ถูกต้อง', 'error')} className="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-primary-200 transition transform active:scale-95">เข้าใช้งาน</button>
                                </div>
                            </div>
                        )}

                        {view === 'teacher' && (
                            <div className="animate-fade-in w-full">
                                <div className="flex flex-wrap items-center justify-between gap-4 mb-8 bg-white p-4 rounded-2xl shadow-soft border border-slate-100 sticky top-20 z-30">
                                    <div className="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0 w-full md:w-auto hide-scrollbar">
                                        {[
                                            {id:'scores', icon:Icons.FileText, label:'คะแนน'},
                                            {id:'analysis', icon:Icons.Chart, label:'วิเคราะห์'},
                                            {id:'activity', icon:Icons.Activity, label:'ความเคลื่อนไหว'},
                                            {id:'students', icon:Icons.Users, label:'รายชื่อ'},
                                            {id:'settings', icon:Icons.Settings, label:'ตั้งค่า'}
                                        ].map(t => (
                                            <button key={t.id} onClick={() => setTeacherTab(t.id)} className={`px-4 py-2.5 rounded-xl font-bold text-sm transition capitalize flex items-center gap-2 whitespace-nowrap ${teacherTab === t.id ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`}>
                                                <t.icon size={16}/> {t.label}
                                            </button>
                                        ))}
                                    </div>
                                    {teacherTab === 'scores' && (
                                        <div className="flex items-center gap-2 w-full md:w-auto">
                                            <button onClick={() => setNumpadOpen(!numpadOpen)} className={`p-2.5 rounded-xl transition ${numpadOpen ? 'bg-primary-100 text-primary-600' : 'bg-slate-100 text-slate-500'}`} title="Virtual Keypad"><Icons.Calculator size={20}/></button>
                                            <button onClick={() => setIsPopupMode(!isPopupMode)} className={`p-2.5 rounded-xl transition ${isPopupMode ? 'bg-primary-100 text-primary-600' : 'bg-slate-100 text-slate-500'}`} title="Popup Mode"><Icons.Popup size={20}/></button>
                                            <select className="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold text-slate-600 outline-none" value={selectedRoom} onChange={e => setSelectedRoom(e.target.value)}>
                                                <option value="All">ทุกห้องเรียน</option>
                                                {uniqueRooms.map(r => <option key={r} value={r}>{r}</option>)}
                                            </select>
                                            <div className="relative flex-1 md:flex-none"><Icons.Search className="absolute left-3 top-2.5 text-slate-400 w-4 h-4"/><input className="w-full md:w-40 pl-9 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-primary-500 transition" placeholder="ค้นหา..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} /></div>
                                            <button onClick={() => setScannerOpen(true)} className="bg-primary-600 text-white p-2.5 rounded-xl hover:bg-primary-700 shadow-md transition"><Icons.Camera/></button>
                                            <button onClick={() => { const id = Math.random().toString(36).substr(2,6).toUpperCase(); setSessionId(id); setMobilePairOpen(true); }} className="bg-white border border-primary-200 text-primary-600 p-2.5 rounded-xl hover:bg-primary-50 transition"><Icons.QrCode/></button>
                                            <button onClick={() => window.print()} className="bg-white border border-slate-200 text-slate-600 p-2.5 rounded-xl hover:bg-slate-50 transition"><Icons.Print/></button>
                                        </div>
                                    )}
                                </div>

                                {teacherTab === 'scores' && (
                                    <div className="bg-white rounded-2xl shadow-soft border border-slate-200 overflow-hidden relative">
                                        <VirtualNumpad isOpen={numpadOpen} onClose={() => setNumpadOpen(false)} onInput={(k) => {
                                            const activeInput = document.activeElement;
                                            if (activeInput && activeInput.tagName === 'INPUT' && !activeInput.readOnly) {
                                                if (k === 'Del') activeInput.value = activeInput.value.slice(0, -1);
                                                else activeInput.value = activeInput.value + k;
                                                activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                                            }
                                        }} />
                                        <ScoreEntryModal 
                                            isOpen={!!activeScoreEntry} 
                                            data={activeScoreEntry} 
                                            onClose={() => setActiveScoreEntry(null)} 
                                            onSave={handleScoreSave}
                                            onNavigate={navigateScoreEntry}
                                        />

                                        <div className="overflow-x-auto max-h-[75vh]">
                                            <table className="min-w-full w-max text-sm text-left border-separate table-fixed" style={{borderSpacing: 0}}>
                                                <thead className="bg-white text-slate-700 font-display z-50 sticky top-0 shadow-sm">
                                                    {/* TOP ROW: Section Headers */}
                                                    <tr>
                                                        <th rowSpan="3" className="p-3 sticky-col sticky-left-0 min-w-[40px] max-w-[40px] text-center border-b border-r border-slate-200 z-[60]">ที่</th>
                                                        <th rowSpan="3" className="p-3 sticky-col sticky-left-1 min-w-[60px] max-w-[60px] border-b border-r border-slate-200 z-[60]">รหัส</th>
                                                        <th rowSpan="3" className="p-3 sticky-col sticky-left-2 min-w-[180px] max-w-[180px] border-b border-r border-slate-200 z-[60]">ชื่อ-นามสกุล</th>
                                                        
                                                        {sections.map((sec, idx) => {
                                                            if (sec.published === false) return null;
                                                            let cols = 0;
                                                            sec.groups?.forEach(g => { if(g.published !== false) cols += (g.columns?.length || 0); });
                                                            if (cols === 0) return null;
                                                            
                                                            // Theme Color Logic
                                                            const themes = SECTION_COLORS;
                                                            const theme = themes[idx % themes.length];

                                                            return (
                                                                <th key={sec.id} colSpan={cols} className={`p-2 text-center border-b border-r border-white text-sm font-bold ${theme.bg} ${theme.text} overflow-hidden text-ellipsis whitespace-nowrap`}>
                                                                    {sec.title}
                                                                </th>
                                                            );
                                                        })}
                                                        <th rowSpan="3" className="p-2 border-b border-l border-slate-200 bg-slate-100 min-w-[40px] text-center font-bold">รวม</th>
                                                        <th rowSpan="3" className="p-2 border-b border-l border-yellow-200 bg-yellow-50 min-w-[40px] text-center font-bold">เกรด</th>
                                                    </tr>

                                                    {/* MIDDLE ROW: Vertical Column Headers */}
                                                    <tr>
                                                        {sections.map((sec, idx) => {
                                                            if (sec.published === false) return null;
                                                            return sec.groups?.map(g => {
                                                                if (g.published === false) return null;
                                                                return g.columns?.map(col => {
                                                                    const isSum = col.type === 'sum' || col.type === 'percent';
                                                                    const theme = SECTION_COLORS[idx % SECTION_COLORS.length];
                                                                    return (
                                                                        <th key={col.id} className={`border-r border-b border-slate-200 relative group min-w-[32px] max-w-[32px] w-[32px] hover:bg-slate-50 transition ${isSum ? 'bg-slate-50' : ''}`}>
                                                                            <div className="vertical-text text-xs font-medium text-slate-600">
                                                                                {col.name}
                                                                            </div>
                                                                        </th>
                                                                    );
                                                                });
                                                            });
                                                        })}
                                                    </tr>

                                                    {/* BOTTOM ROW: Max Scores */}
                                                    <tr className="bg-slate-50 text-xs font-mono text-slate-500">
                                                        {sections.map((sec, idx) => {
                                                            if (sec.published === false) return null;
                                                            return sec.groups?.map(g => {
                                                                if (g.published === false) return null;
                                                                return g.columns?.map(col => {
                                                                    const theme = SECTION_COLORS[idx % SECTION_COLORS.length];
                                                                    return (
                                                                        <th key={col.id} className={`p-1 text-center border-r border-b border-slate-200 font-bold ${theme.bg} ${theme.text} bg-opacity-30`}>
                                                                            {col.max}
                                                                        </th>
                                                                    );
                                                                });
                                                            });
                                                        })}
                                                    </tr>
                                                </thead>

                                                <tbody className="divide-y divide-slate-100 bg-white">
                                                    {filteredStudents.map((s, idx) => {
                                                        const totalScore = calculateTotalScore(s);
                                                        return (
                                                            <tr key={s.id} className={`hover:bg-blue-50/20 transition group ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50/30'}`}> 
                                                                <td className={`p-1 text-center sticky-col sticky-left-0 transition font-mono text-slate-400 border-r border-slate-100 text-xs ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}`}>{s.no}</td>
                                                                <td className={`p-1 text-center sticky-col sticky-left-1 transition font-mono font-bold text-slate-500 text-[10px] border-r border-slate-100 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}`}>{s.id}</td>
                                                                <td className={`p-2 sticky-col sticky-left-2 transition font-medium text-slate-700 truncate border-r border-slate-100 max-w-[180px] text-sm ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}`}>
                                                                    <div className="flex items-center justify-between w-full overflow-hidden">
                                                                        <span className="truncate" title={s.name}>{s.name}</span>
                                                                        {s.note && <div className="text-[9px] bg-yellow-100 text-yellow-700 px-1 rounded ml-1 flex-shrink-0" title={s.note}>!</div>}
                                                                    </div>
                                                                </td>
                                                                
                                                                {sections.map(sec => {
                                                                    if (sec.published === false) return null;
                                                                    return sec.groups?.map(g => {
                                                                        if (g.published === false) return null;
                                                                        return g.columns?.map(col => {
                                                                            const isAuto = col.type !== 'manual';
                                                                            const val = isAuto ? calculateAutoScore(s, g, col) : s.scores?.[col.id];
                                                                            return (
                                                                                <td key={col.id} className={`p-0 border-r border-slate-100 text-center relative h-8 min-w-[32px] max-w-[32px] w-[32px] ${isAuto ? 'bg-slate-50' : ''}`}>
                                                                                    {isAuto ? 
                                                                                        <div className="flex items-center justify-center h-full text-slate-800 font-bold text-xs">{val}</div> : 
                                                                                        <div onClick={() => isPopupMode && openScoreModal(s, col)} className="w-full h-full">
                                                                                            <input 
                                                                                                className={`w-full h-full text-center bg-transparent outline-none focus:bg-blue-100 focus:text-blue-700 transition font-mono text-slate-600 hover:bg-slate-50 text-sm ${isPopupMode ? 'cursor-pointer pointer-events-none' : ''}`}
                                                                                                value={val || ''} 
                                                                                                placeholder=""
                                                                                                readOnly={isPopupMode}
                                                                                                onFocus={(e) => { if(numpadOpen) e.target.readOnly = true; }}
                                                                                                onClick={(e) => { if(numpadOpen && !isPopupMode) { e.target.readOnly = false; e.target.focus(); e.target.readOnly = true; } }}
                                                                                                onChange={e => {
                                                                                                    const v = e.target.value;
                                                                                                    if (v === '' || (!isNaN(v) && parseFloat(v) <= parseFloat(col.max))) {
                                                                                                        const newScores = { ...s.scores, [col.id]: v };
                                                                                                        setStudents(prev => prev.map(p => p.id === s.id ? { ...s, scores: newScores } : p)); 
                                                                                                        updateStudent({ ...s, scores: newScores });
                                                                                                    }
                                                                                                }}
                                                                                            />
                                                                                        </div>
                                                                                    }
                                                                                </td>
                                                                            );
                                                                        });
                                                                    });
                                                                })}
                                                                <td className="p-1 text-center font-bold text-slate-800 border-l border-slate-200 bg-slate-50 text-xs">{totalScore}</td>
                                                                <td className={`p-1 text-center font-bold text-white border-l border-yellow-200 text-xs ${totalScore < 50 ? 'bg-red-400' : 'bg-yellow-400'}`}>{calculateGrade(totalScore)}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                                <tfoot className="bg-slate-800 text-white text-[10px] font-mono sticky bottom-0 z-40 shadow-lg">
                                                    <tr>
                                                        <td colSpan="3" className="p-2 text-right font-bold bg-slate-900 sticky-col sticky-left-0 border-r border-slate-700 z-50">AVG</td>
                                                        {sections.map(sec => {
                                                            if (sec.published === false) return null;
                                                            return sec.groups?.map(g => {
                                                                if (g.published === false) return null;
                                                                return g.columns?.map(col => {
                                                                    const stats = col.type === 'manual' ? calculateColumnStats(col.id) : { avg: '-' };
                                                                    return <td key={col.id} className="p-1 text-center border-r border-slate-700 text-slate-300 min-w-[32px] max-w-[32px]" title={`Min: ${stats.min}, Max: ${stats.max}`}>{stats.avg}</td>
                                                                });
                                                            });
                                                        })}
                                                        <td colSpan="2" className="bg-slate-900"></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* Other tabs remain the same as previous logic, just referencing for completeness */}
                                {teacherTab === 'analysis' && (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {/* Reuse Analysis Logic */}
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-green-100"><div className="text-green-600 font-bold text-lg mb-2">กลุ่มเก่ง (Excellent)</div><div className="text-4xl font-bold text-slate-800 mb-4">{analysisData.high.length} <span className="text-sm font-normal text-slate-400">คน</span></div><div className="h-40 overflow-y-auto space-y-2">{analysisData.high.map(s => <div key={s.id} className="text-sm border-b border-slate-50 py-1 flex justify-between"><span>{s.name}</span><span className="font-bold text-green-500">{calculateTotalScore(s)}</span></div>)}</div></div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-yellow-100"><div className="text-yellow-600 font-bold text-lg mb-2">กลุ่มปานกลาง (Average)</div><div className="text-4xl font-bold text-slate-800 mb-4">{analysisData.mid.length} <span className="text-sm font-normal text-slate-400">คน</span></div><div className="h-40 overflow-y-auto space-y-2">{analysisData.mid.map(s => <div key={s.id} className="text-sm border-b border-slate-50 py-1 flex justify-between"><span>{s.name}</span><span className="font-bold text-yellow-500">{calculateTotalScore(s)}</span></div>)}</div></div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-red-100"><div className="text-red-600 font-bold text-lg mb-2">กลุ่มต้องปรับปรุง (Improve)</div><div className="text-4xl font-bold text-slate-800 mb-4">{analysisData.low.length} <span className="text-sm font-normal text-slate-400">คน</span></div><div className="h-40 overflow-y-auto space-y-2">{analysisData.low.map(s => <div key={s.id} className="text-sm border-b border-slate-50 py-1 flex justify-between"><span>{s.name}</span><span className="font-bold text-red-500">{calculateTotalScore(s)}</span></div>)}</div></div>
                                    </div>
                                )}

                                {teacherTab === 'activity' && (
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className="bg-white rounded-2xl shadow-sm p-6 border border-slate-200"><h3 className="font-bold mb-4 flex items-center gap-2"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> ใช้งานอยู่ขณะนี้ ({presence.length})</h3><div className="space-y-3">{presence.map((p, i) => (<div key={i} className="flex justify-between items-center bg-slate-50 p-3 rounded-xl"><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${p.role==='teacher'?'bg-purple-100 text-purple-600':'bg-blue-100 text-blue-600'}`}><Icons.User size={16}/></div><div><div className="font-bold text-sm text-slate-700">{p.role === 'teacher' ? 'ครูผู้สอน' : 'นักเรียน/ผู้ปกครอง'}</div><div className="text-xs text-slate-400">{p.viewing ? `กำลังดู: ${p.viewing}` : 'หน้าหลัก'}</div></div></div><span className="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded">Online</span></div>))}</div></div>
                                        <div className="bg-white rounded-2xl shadow-sm p-6 border border-slate-200"><h3 className="font-bold mb-4 flex items-center gap-2"><Icons.LogOut size={18}/> ประวัติการเข้าดู (ล่าสุด)</h3><div className="space-y-3">{accessLogs.map((l, i) => (<div key={i} className="flex justify-between items-center text-sm border-b border-slate-50 pb-2 last:border-0"><div><div className="font-bold text-slate-700">{l.student} ({l.room})</div><div className="text-xs text-slate-400 font-mono">ID: {l.id}</div></div><div className="text-xs text-slate-400">{new Date(l.time).toLocaleTimeString('th-TH')}</div></div>))}</div></div>
                                    </div>
                                )}

                                {teacherTab === 'students' && (
                                    <div className="bg-white rounded-2xl shadow-soft border border-slate-200 p-6">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="font-bold text-lg text-slate-800">จัดการรายชื่อ ({filteredStudents.length})</h3>
                                            <div className="flex gap-2">
                                                <button onClick={() => setModal({ type: 'import' })} className="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-50 transition flex items-center gap-2"><Icons.Upload size={16}/> Import Excel</button>
                                                <button onClick={() => { setModal({ type: 'student_edit', data: { id: '', name: '', room: '', no: '', note: '' } }) }} className="bg-primary-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-primary-700 transition flex items-center gap-2"><Icons.Plus size={16}/> เพิ่มนักเรียน</button>
                                            </div>
                                        </div>
                                        <table className="w-full text-left">
                                            <thead className="bg-slate-50 text-slate-500 font-display text-sm"><tr><th className="p-3 rounded-l-xl">ID</th><th className="p-3">Name</th><th className="p-3">Room</th><th className="p-3">No</th><th className="p-3">Note</th><th className="p-3 rounded-r-xl text-right">Actions</th></tr></thead>
                                            <tbody className="text-sm">{filteredStudents.map(s => (<tr key={s.id} className="border-b border-slate-50 hover:bg-slate-50 transition"><td className="p-3 font-mono font-bold text-slate-400">{s.id}</td><td className="p-3 font-medium text-slate-700">{s.name}</td><td className="p-3"><span className="bg-primary-50 text-primary-700 px-2 py-1 rounded text-xs font-bold">{s.room}</span></td><td className="p-3 text-slate-500">{s.no}</td><td className="p-3 text-slate-400 text-xs italic">{s.note || '-'}</td><td className="p-3 text-right flex justify-end gap-2"><button onClick={() => setModal({ type: 'student_edit', data: s })} className="text-slate-400 hover:text-primary-600 p-1"><Icons.Edit size={16}/></button><button onClick={() => deleteStudent(s.id)} className="text-slate-400 hover:text-red-500 p-1"><Icons.Trash size={16}/></button></td></tr>))}</tbody>
                                        </table>
                                    </div>
                                )}

                                {teacherTab === 'settings' && (
                                    <div className="space-y-8 max-w-5xl mx-auto">
                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex items-center gap-3">
                                                <div className="bg-blue-100 text-blue-600 p-2 rounded-lg"><Icons.Settings size={20}/></div>
                                                <h3 className="font-bold text-lg text-slate-800">ข้อมูลรายวิชา (General Info)</h3>
                                            </div>
                                            <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div><label className="text-xs font-bold text-slate-400 uppercase">ชื่อโรงเรียน</label><input className="w-full p-2 border rounded-lg bg-slate-50" value={sysInfo.school} onChange={e => { const n = {...sysInfo, school: e.target.value}; setSysInfo(n); saveConfig(null, n); }} /></div>
                                                <div><label className="text-xs font-bold text-slate-400 uppercase">ชื่อครูผู้สอน</label><input className="w-full p-2 border rounded-lg bg-slate-50" value={sysInfo.teacher} onChange={e => { const n = {...sysInfo, teacher: e.target.value}; setSysInfo(n); saveConfig(null, n); }} /></div>
                                                <div><label className="text-xs font-bold text-slate-400 uppercase">ชื่อรายวิชา</label><input className="w-full p-2 border rounded-lg bg-slate-50" value={sysInfo.subject} onChange={e => { const n = {...sysInfo, subject: e.target.value}; setSysInfo(n); saveConfig(null, n); }} /></div>
                                                <div className="flex gap-2">
                                                    <div className="flex-1"><label className="text-xs font-bold text-slate-400 uppercase">รหัสวิชา</label><input className="w-full p-2 border rounded-lg bg-slate-50" value={sysInfo.code} onChange={e => { const n = {...sysInfo, code: e.target.value}; setSysInfo(n); saveConfig(null, n); }} /></div>
                                                    <div className="w-1/3"><label className="text-xs font-bold text-slate-400 uppercase">ปีการศึกษา</label><input className="w-full p-2 border rounded-lg bg-slate-50" value={sysInfo.year} onChange={e => { const n = {...sysInfo, year: e.target.value}; setSysInfo(n); saveConfig(null, n); }} /></div>
                                                </div>
                                                <div><label className="text-xs font-bold text-red-400 uppercase">รหัสผ่านครู</label><input className="w-full p-2 border border-red-100 rounded-lg bg-red-50 text-red-600 font-mono" value={sysInfo.password} onChange={e => { const n = {...sysInfo, password: e.target.value}; setSysInfo(n); saveConfig(null, n); }} /></div>
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-orange-100 text-orange-600 p-2 rounded-lg"><Icons.Chart size={20}/></div>
                                                    <h3 className="font-bold text-lg text-slate-800">เกณฑ์การตัดเกรด (Grading Scale)</h3>
                                                </div>
                                                <button onClick={() => { setSysInfo({...sysInfo, grading: DEFAULT_INFO.grading}); saveConfig(null, {...sysInfo, grading: DEFAULT_INFO.grading}); showToast('คืนค่าเกณฑ์มาตรฐานแล้ว'); }} className="text-xs text-orange-600 bg-orange-50 px-3 py-1 rounded-lg hover:bg-orange-100 font-bold flex items-center gap-1"><Icons.Refresh size={12}/> Reset</button>
                                            </div>
                                            <div className="p-6 grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-4">
                                                {['4', '3.5', '3', '2.5', '2', '1.5', '1', '0'].map(g => (
                                                    g !== '0' && (
                                                        <div key={g} className="bg-slate-50 p-3 rounded-xl border border-slate-200 text-center">
                                                            <div className="text-2xl font-bold text-slate-700 mb-1">{g}</div>
                                                            <div className="text-[10px] text-slate-400 uppercase mb-1">Min Score</div>
                                                            <input type="number" className="w-full text-center p-1 rounded border border-slate-300 font-bold text-primary-600" value={(sysInfo.grading || DEFAULT_INFO.grading)[g]} onChange={e => {
                                                                const newGrading = { ...(sysInfo.grading || DEFAULT_INFO.grading), [g]: parseFloat(e.target.value) };
                                                                const newInfo = { ...sysInfo, grading: newGrading };
                                                                setSysInfo(newInfo); saveConfig(null, newInfo);
                                                            }} />
                                                        </div>
                                                    )
                                                ))}
                                            </div>
                                        </div>

                                        {/* New Data Management Card */}
                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex items-center gap-3">
                                                <div className="bg-indigo-100 text-indigo-600 p-2 rounded-lg"><Icons.Database size={20}/></div>
                                                <h3 className="font-bold text-lg text-slate-800">จัดการข้อมูล (Data Management)</h3>
                                            </div>
                                            <div className="p-6">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                                    <div className="border rounded-xl p-4 bg-slate-50 hover:bg-white transition-colors">
                                                        <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2"><Icons.Download size={16}/> สำรองข้อมูล</h4>
                                                        <p className="text-xs text-slate-500 mb-4">ดาวน์โหลดข้อมูลทั้งหมดเก็บไว้ (รายชื่อ, คะแนน, การตั้งค่า) เป็นไฟล์ .json</p>
                                                        <div className="flex gap-2">
                                                            <button onClick={handleExportCSV} className="flex-1 py-2 text-sm bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-green-600 font-bold hover:border-green-300 transition">Export CSV (Excel)</button>
                                                            <button onClick={handleBackup} className="flex-1 py-2 text-sm bg-slate-800 text-white rounded-lg hover:bg-slate-900 font-bold transition">Backup JSON</button>
                                                        </div>
                                                    </div>
                                                    <div className="border rounded-xl p-4 bg-slate-50 hover:bg-white transition-colors">
                                                        <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2"><Icons.Upload size={16}/> กู้คืนข้อมูล</h4>
                                                        <p className="text-xs text-slate-500 mb-4">นำไฟล์ .json ที่สำรองไว้กลับมาใช้งาน</p>
                                                        <input type="file" ref={restoreInputRef} onChange={handleRestore} className="hidden" accept=".json" />
                                                        <button onClick={() => restoreInputRef.current.click()} className="w-full py-2 text-sm bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-indigo-600 font-bold hover:border-indigo-300 transition">เลือกไฟล์ Backup (.json)</button>
                                                    </div>
                                                </div>
                                                
                                                <div className="border-t pt-6">
                                                    <h4 className="font-bold text-red-600 mb-2 text-sm uppercase tracking-wider flex items-center gap-2"><Icons.Alert size={16}/> Danger Zone</h4>
                                                    <div className="flex justify-between items-center bg-red-50 p-4 rounded-xl border border-red-100">
                                                        <div className="text-sm text-red-800">
                                                            <strong>ล้างข้อมูลทั้งหมด (Factory Reset)</strong><br/>
                                                            ลบรายชื่อนักเรียนและคะแนนทั้งหมด แต่เก็บโครงสร้างวิชาไว้
                                                        </div>
                                                        <button onClick={handleClearData} className="px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg font-bold hover:bg-red-600 hover:text-white transition shadow-sm text-sm">ล้างข้อมูล</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="space-y-4">
                                            <div className="flex justify-between items-end">
                                                <div><h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icons.Database className="text-primary-600"/> โครงสร้างคะแนน</h3></div>
                                                <button onClick={() => { const newSecs = [...sections, { id: 's'+Date.now(), title: '', groups: [] }]; setSections(newSecs); saveConfig(newSecs); }} className="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold hover:bg-slate-900 shadow-lg flex items-center gap-2 transition transform active:scale-95"><Icons.Plus size={18}/> เพิ่มบทเรียน</button>
                                            </div>
                                            <div className="grid gap-6">
                                                {sections.map((sec, sIdx) => {
                                                    const theme = SECTION_COLORS[sIdx % SECTION_COLORS.length];
                                                    return (
                                                    <div key={sec.id} className="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden transition hover:shadow-md">
                                                        <div className={`px-6 py-4 border-b border-slate-100 flex flex-wrap gap-4 justify-between items-center group ${theme.bg} bg-opacity-20`}>
                                                            <div className="flex items-center gap-4 flex-1">
                                                                <span className="bg-white border border-slate-200 w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 font-bold text-sm">{sIdx + 1}</span>
                                                                <div className="flex-1"><label className="text-[10px] text-slate-400 font-bold uppercase tracking-wider block mb-0.5">ชื่อบทเรียน</label><input className="w-full bg-transparent font-bold text-lg text-slate-800 outline-none focus:border-b-2 focus:border-primary-500 transition-all placeholder-slate-400" placeholder="เช่น บทที่ 1..." value={sec.title} onChange={e => { const newSecs = [...sections]; newSecs[sIdx].title = e.target.value; setSections(newSecs); saveConfig(newSecs); }} /></div>
                                                            </div>
                                                            <div className="flex items-center gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                                                <button onClick={() => { const newSecs = [...sections]; newSecs[sIdx].groups = [...(newSecs[sIdx].groups || []), { id: Date.now(), title: '', columns: [] }]; setSections(newSecs); saveConfig(newSecs); }} className="text-xs bg-white text-slate-700 hover:bg-slate-50 px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 transition shadow-sm border border-slate-200"><Icons.Plus size={14}/> เพิ่มกลุ่ม</button>
                                                                <button onClick={() => { setModal({ type: 'confirm', title: 'ลบบทเรียน', message: 'ยืนยัน?', onConfirm: () => { const newSecs = sections.filter((_, i) => i !== sIdx); setSections(newSecs); saveConfig(newSecs); setModal(null); }}); }} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"><Icons.Trash size={18}/></button>
                                                            </div>
                                                        </div>
                                                        <div className="p-6 space-y-6 bg-white">
                                                            {sec.groups?.map((grp, gIdx) => (
                                                                <div key={grp.id} className="relative pl-4 border-l-2 border-slate-100 hover:border-primary-200 transition-colors">
                                                                    <div className="flex justify-between items-start mb-3">
                                                                        <div className="flex-1"><input className="bg-transparent font-bold text-slate-700 text-sm outline-none focus:text-primary-600 transition w-full placeholder-slate-300" placeholder="ชื่อกลุ่ม (ไม่บังคับ)..." value={grp.title} onChange={e => { const newSecs = [...sections]; newSecs[sIdx].groups[gIdx].title = e.target.value; setSections(newSecs); saveConfig(newSecs); }} /></div>
                                                                        <div className="flex gap-2">
                                                                            <button onClick={() => { const newSecs = [...sections]; newSecs[sIdx].groups[gIdx].columns.push({ id: 'c'+Date.now(), name: '', max: 10, type: 'manual' }); setSections(newSecs); saveConfig(newSecs); }} className="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded font-bold transition flex items-center gap-1"><Icons.Plus size={10}/> ช่องคะแนน</button>
                                                                            <button onClick={() => { const newSecs = [...sections]; newSecs[sIdx].groups.splice(gIdx, 1); setSections(newSecs); saveConfig(newSecs); }} className="text-slate-300 hover:text-red-400"><Icons.X size={14}/></button>
                                                                        </div>
                                                                    </div>
                                                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                                                                        {grp.columns?.map((col, cIdx) => (
                                                                            <div key={col.id} className="bg-slate-50 border border-slate-200 rounded-xl p-3 flex flex-col gap-2 relative group/col hover:border-primary-300 hover:shadow-sm transition">
                                                                                <input className="bg-transparent text-xs font-bold text-slate-700 outline-none w-full placeholder-slate-300" value={col.name} placeholder="ชื่อช่อง" onChange={e => { const newSecs = [...sections]; newSecs[sIdx].groups[gIdx].columns[cIdx].name = e.target.value; setSections(newSecs); saveConfig(newSecs); }} />
                                                                                <div className="flex items-center justify-between">
                                                                                    <div className="flex items-center gap-1 bg-white border border-slate-200 rounded px-1.5 py-0.5"><span className="text-[9px] text-slate-400">Max</span><input className="w-6 text-center text-[10px] font-mono outline-none text-slate-600" value={col.max} onChange={e => { const newSecs = [...sections]; newSecs[sIdx].groups[gIdx].columns[cIdx].max = e.target.value; setSections(newSecs); saveConfig(newSecs); }} /></div>
                                                                                    <button onClick={() => { const newSecs = [...sections]; const types = ['manual', 'sum', 'percent']; const nextType = types[(types.indexOf(col.type) + 1) % types.length]; newSecs[sIdx].groups[gIdx].columns[cIdx].type = nextType; setSections(newSecs); saveConfig(newSecs); }} className={`text-[9px] font-bold px-1.5 py-0.5 rounded border ${col.type === 'manual' ? 'bg-white border-slate-200 text-slate-400' : col.type === 'sum' ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-orange-50 border-orange-200 text-orange-600'}`}>{col.type === 'manual' ? 'MAN' : col.type === 'sum' ? 'SUM' : '%'}</button>
                                                                                </div>
                                                                                <button onClick={() => { const newSecs = [...sections]; newSecs[sIdx].groups[gIdx].columns.splice(cIdx, 1); setSections(newSecs); saveConfig(newSecs); }} className="absolute -top-2 -right-2 bg-white text-red-400 border border-red-100 rounded-full p-0.5 opacity-0 group-hover/col:opacity-100 shadow-sm hover:bg-red-50 transition"><Icons.X size={12}/></button>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );})}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* MODALS & PRINT */}
                    {scannerOpen && <Scanner onScan={(txt) => { setScannerOpen(false); handleScan(txt); }} onClose={() => setScannerOpen(false)} />}
                    {mobilePairOpen && <MobilePairModal sessionId={sessionId} onClose={() => setMobilePairOpen(false)} />}
                    <Modal isOpen={modal?.type === 'confirm'} title={modal?.title} onClose={() => setModal(null)} footer={<><button onClick={() => setModal(null)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-bold">ยกเลิก</button><button onClick={modal?.onConfirm} className="px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600">ยืนยัน</button></>}> <p className="text-slate-600">{modal?.message}</p> </Modal>
                    <Modal isOpen={modal?.type === 'student_edit'} title={modal?.data?.id ? 'แก้ไขข้อมูล' : 'เพิ่มนักเรียน'} onClose={() => setModal(null)} footer={<button onClick={() => { if(!modal.data.id || !modal.data.name) return showToast('กรอกข้อมูลให้ครบ', 'error'); updateStudent(modal.data); setModal(null); }} className="w-full py-3 bg-primary-600 text-white rounded-xl font-bold hover:bg-primary-700">บันทึก</button>}> 
                        <div className="space-y-3">
                            <input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl" placeholder="รหัสประจำตัว" value={modal?.data?.id || ''} onChange={e => setModal({...modal, data: {...modal.data, id: e.target.value}})} disabled={!!modal?.data?.scores} />
                            <input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl" placeholder="ชื่อ-นามสกุล" value={modal?.data?.name || ''} onChange={e => setModal({...modal, data: {...modal.data, name: e.target.value}})} />
                            <div className="flex gap-3">
                                <input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl" placeholder="ห้อง" value={modal?.data?.room || ''} onChange={e => setModal({...modal, data: {...modal.data, room: e.target.value}})} />
                                <input className="w-24 p-3 bg-slate-50 border border-slate-200 rounded-xl text-center" placeholder="เลขที่" value={modal?.data?.no || ''} onChange={e => setModal({...modal, data: {...modal.data, no: e.target.value}})} />
                            </div>
                            <textarea className="w-full p-3 bg-yellow-50 border border-yellow-200 rounded-xl text-sm" placeholder="หมายเหตุ (เช่น ลาป่วย, ขาดสอบ)..." value={modal?.data?.note || ''} onChange={e => setModal({...modal, data: {...modal.data, note: e.target.value}})}></textarea>
                        </div> 
                    </Modal>
                    <Modal isOpen={modal?.type === 'import'} title="นำเข้าข้อมูล (Excel Copy)" onClose={() => setModal(null)} footer={<button onClick={handleImport} disabled={isImporting} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">{isImporting ? 'กำลังประมวลผล...' : 'เริ่มนำเข้า'}</button>}> <div className="bg-yellow-50 text-yellow-700 text-xs p-3 rounded-lg mb-3 border border-yellow-100">รูปแบบ: <strong>รหัส [tab] ชื่อ [tab] ห้อง [tab] เลขที่</strong></div><textarea className="w-full h-40 p-3 bg-slate-50 border border-slate-200 rounded-xl font-mono text-xs focus:ring-2 focus:ring-primary-500 outline-none" placeholder="66001  สมชาย  1/1  1..." value={importText} onChange={e => setImportText(e.target.value)}></textarea></Modal>

                    {/* PRINT LAYOUT */}
                    <div className="print-only">
                        {studentViewData && (
                            <div className="p-8">
                                <div className="report-header"><h1>รายงานผลการเรียนรายบุคคล</h1><h2>{sysInfo.subject} ({sysInfo.code})</h2><p>ปีการศึกษา {sysInfo.year} | {sysInfo.school}</p></div>
                                <div className="flex justify-between mb-6 text-lg border-b border-gray-300 pb-4"><div><p><strong>ชื่อ-สกุล:</strong> {studentViewData.name}</p><p><strong>รหัสประจำตัว:</strong> {studentViewData.id}</p></div><div className="text-right"><p><strong>ชั้น:</strong> {studentViewData.room}</p><p><strong>เลขที่:</strong> {studentViewData.no}</p></div></div>
                                <table><thead><tr className="bg-gray-200"><th className="text-left w-3/5">รายการประเมิน</th><th className="w-1/5">คะแนนเต็ม</th><th className="w-1/5">คะแนนที่ได้</th></tr></thead><tbody>{sections.map(sec => sec.published !== false && (<React.Fragment key={sec.id}><tr><td colSpan="3" className="text-left font-bold bg-gray-100">{sec.title}</td></tr>{sec.groups?.map(grp => grp.published !== false && grp.columns?.map(col => { let val = col.type === 'manual' ? getScore(studentViewData, col.id) : calculateAutoScore(studentViewData, grp, col); let max = col.max; let width = (parseFloat(val)/parseFloat(max))*50; return <tr key={col.id}><td className="text-left pl-6 flex justify-between"><span>{col.name}</span><div className="progress-bar-print"><div className="progress-fill-print" style={{width: width+'px'}}></div></div></td><td>{max}</td><td className="font-bold">{val}</td></tr>; }))}</React.Fragment>))}
                                <tr className="bg-slate-100 border-t-2 border-black"><td className="text-right font-bold pr-4">รวมคะแนน</td><td>100</td><td className="font-bold">{calculateTotalScore(studentViewData)}</td></tr>
                                <tr className="bg-yellow-50"><td className="text-right font-bold pr-4">เกรดที่ได้</td><td></td><td className="font-bold text-lg">{calculateGrade(calculateTotalScore(studentViewData))}</td></tr>
                                </tbody></table>
                                {studentViewData.note && <div className="mb-4 text-sm"><strong>หมายเหตุ:</strong> {studentViewData.note}</div>}
                                <div className="signature-section"><div className="signature-block"><div className="signature-line"></div><p>({sysInfo.teacher})</p><p>ครูผู้สอน</p></div><div className="signature-block"><div className="signature-line"></div><p>ลงชื่อผู้ปกครอง</p></div></div>
                            </div>
                        )}
                        {!studentViewData && teacherTab === 'scores' && (
                            <div className="p-4 landscape-mode">
                                <div className="report-header"><h1>ใบบันทึกคะแนน - ห้อง {selectedRoom}</h1><p>{sysInfo.subject} ({sysInfo.code}) | {sysInfo.school}</p></div>
                                <table>
                                    <thead>
                                        {/* Multi-row Header for Print */}
                                        <tr>
                                            <th rowSpan="3" className="text-center" style={{width: '30px'}}>ที่</th>
                                            <th rowSpan="3" style={{width: '60px'}}>รหัส</th>
                                            <th rowSpan="3" style={{width: '150px'}}>ชื่อ-นามสกุล</th>
                                            <th rowSpan="3" style={{width: '30px'}}>ห้อง</th>
                                            {sections.map(sec => {
                                                if (sec.published === false) return null;
                                                let cols = 0;
                                                sec.groups?.forEach(g => { if(g.published !== false) cols += (g.columns?.length || 0); });
                                                if(cols===0) return null;
                                                return <th key={sec.id} colSpan={cols} style={{backgroundColor: '#f0f9ff'}}>{sec.title}</th>;
                                            })}
                                            <th rowSpan="3">รวม</th>
                                            <th rowSpan="3">เกรด</th>
                                        </tr>
                                        <tr>
                                            {sections.map(sec => {
                                                if (sec.published === false) return null;
                                                return sec.groups?.map(g => {
                                                    if(g.published === false) return null;
                                                    return g.columns?.map(col => (
                                                        <th key={col.id} className="vertical-text-print" style={{height:'100px', fontSize:'9pt'}}>{col.name}</th>
                                                    ));
                                                });
                                            })}
                                        </tr>
                                        <tr>
                                            {sections.map(sec => {
                                                if (sec.published === false) return null;
                                                return sec.groups?.map(g => {
                                                    if(g.published === false) return null;
                                                    return g.columns?.map(col => (
                                                        <th key={col.id} style={{fontSize:'8pt'}}>{col.max}</th>
                                                    ));
                                                });
                                            })}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredStudents.map(s => { 
                                            const total = calculateTotalScore(s); 
                                            return (
                                                <tr key={s.id}>
                                                    <td>{s.no}</td>
                                                    <td>{s.id}</td>
                                                    <td className="text-left">{s.name}</td>
                                                    <td>{s.room}</td>
                                                    {sections.map(s => s.groups?.map(g => g.columns?.map(c => { 
                                                        const val = c.type === 'manual' ? s.scores?.[c.id] : calculateAutoScore(s, g, c); 
                                                        return <td key={c.id}>{val || ''}</td> 
                                                    })))}
                                                    <td className="font-bold">{total}</td>
                                                    <td className="font-bold bg-gray-100">{calculateGrade(total)}</td>
                                                </tr>
                                            ); 
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
